<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Analis Kesehatan - PDF & WORD Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        #pdf-content { background: white; width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); color: #333; }
        .table-laporan { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table-laporan th, .table-laporan td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 10pt; }
        .table-laporan th { background-color: #f2f2f2; }
        .section-title { border-bottom: 2px solid #1b5e20; color: #1b5e20; font-weight: bold; margin-top: 20px; text-transform: uppercase; }
        .recommendation-box { background-color: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; margin-top: 15px; border-left: 5px solid #2e7d32; }
        .custom-cmd { background-color: #fff9c4; border: 1px solid #fbc02d; }
        .control-panel { max-width: 950px; margin: 0 auto 20px auto; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="container no-print control-panel">
    <div class="card p-4 shadow-sm border-0">
        <h5 class="fw-bold text-success mb-3">Panel Analis AI Puskesmas (Gemini)</h5>
        <div class="row">
            <div class="col-md-6">
                <label class="fw-bold small">1. Data Excel / Narasi:</label>
                <textarea id="rawInput" class="form-control mb-3" rows="6" placeholder="Salin tabel Excel di sini..."></textarea>
            </div>
            <div class="col-md-6">
                <label class="fw-bold small">2. Instruksi Khusus (Perintah):</label>
                <textarea id="customCommand" class="form-control custom-cmd mb-3" rows="6" placeholder="Contoh: 'Tulis dalam gaya formal' atau 'Fokus pada solusi SDM'"></textarea>
            </div>
        </div>
        <div class="row g-2">
            <div class="col-md-4"><input type="password" id="apiKey" class="form-control" placeholder="Gemini API Key"></div>
            <div class="col-md-3"><button onclick="analisisGemini()" class="btn btn-success w-100 fw-bold">PROSES ANALISA âœ¨</button></div>
            <div class="col-md-2"><button onclick="downloadPDF()" class="btn btn-danger w-100">PDF ðŸ“„</button></div>
            <div class="col-md-3"><button onclick="downloadWord()" class="btn btn-primary w-100">SIMPAN WORD ðŸ“¥</button></div>
        </div>
    </div>
</div>

<div id="pdf-content">
    <div id="report-word-area"> <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-weight: bold;">LAPORAN ANALISIS KESEHATAN</h2>
            <p id="tglLaporan" style="color: #666;"></p>
        </div>

        <div id="outputArea">
            <p style="text-align: center; color: #999; margin-top: 50px;">Data belum diproses.</p>
        </div>
    </div>

    <div id="chartArea" style="display:none;" class="mt-4">
        <div class="section-title">Visualisasi Capaian</div>
        <div style="height: 300px;"><canvas id="autoChart"></canvas></div>
        <p class="small text-muted">*Grafik hanya muncul sempurna di PDF/Layar. Untuk Word, grafik dapat ditempel manual dari layar.</p>
    </div>
</div>

<script>
    let myChart = null;

    async function analisisGemini() {
        const text = document.getElementById('rawInput').value;
        const command = document.getElementById('customCommand').value;
        const key = document.getElementById('apiKey').value;
        
        if(!key) return alert("Masukkan API Key!");
        localStorage.setItem('gemini_key', key);

        document.getElementById('outputArea').innerHTML = "<div style='text-align:center; padding: 50px;'>Menyusun laporan...</div>";

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
        const prompt = `Analisis data ini. Jika ada tabel excel (tab-separated), ubah ke tabel HTML class='table-laporan'. Berikan analisa & rekomendasi sesuai perintah user: "${command}". Output JSON: {"ringkasan": "str", "tabel_html": "str", "data_grafik": {"labels":[], "values":[]}, "analisa": "str", "rekomendasi": ["str"]}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt + " Data: " + text }] }] })
            });
            const resData = await response.json();
            const data = JSON.parse(resData.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
            renderLaporan(data);
        } catch (e) { alert("Terjadi kesalahan."); }
    }

    function renderLaporan(data) {
        document.getElementById('outputArea').innerHTML = `
            <div class="section-title">I. Ringkasan</div><p>${data.ringkasan}</p>
            <div class="section-title">II. Tabel Data</div><div>${data.tabel_html}</div>
            <div class="section-title">III. Analisa Masalah</div><p>${data.analisa}</p>
            <div class="recommendation-box"><strong>IV. Rekomendasi Perbaikan:</strong><ul>${data.rekomendasi.map(r => `<li>${r}</li>`).join('')}</ul></div>
        `;
        document.getElementById('chartArea').style.display = 'block';
        updateChart(data.data_grafik.labels, data.data_grafik.values);
    }

    function updateChart(labels, values) {
        const ctx = document.getElementById('autoChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Capaian (%)', data: values, backgroundColor: '#1b5e20' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function downloadPDF() {
        html2pdf().from(document.getElementById('pdf-content')).save('Laporan_Puskesmas.pdf');
    }

    function downloadWord() {
        // Mengambil konten HTML dari area laporan
        const content = document.getElementById('report-word-area').innerHTML;
        const converted = htmlDocx.asBlob(`<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${content}</body></html>`);
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(converted);
        link.download = 'Laporan_Puskesmas.docx';
        link.click();
    }

    window.onload = () => {
        document.getElementById('tglLaporan').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        if(localStorage.getItem('gemini_key')) document.getElementById('apiKey').value = localStorage.getItem('gemini_key');
    };
</script>
</body>
</html>
