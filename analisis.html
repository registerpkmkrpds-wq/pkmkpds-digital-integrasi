<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Data | PKM Kiarapedes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        :root { --bg: #f1f5f9; --glass: rgba(255,255,255,0.9); --text: #0f172a; --border: rgba(0,0,0,0.05); }
        .dark { --bg: #0f172a; --glass: rgba(30,41,59,0.7); --text: #f8fafc; --border: rgba(255,255,255,0.1); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); transition: all 0.3s ease; }
        .glass { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 2rem; }
        @media print { .no-print { display: none !important; } }

        /* Sidebar Styles */
#sidebar { transition: all 0.3s ease; width: 260px; z-index: 1000; }
#sidebar.collapsed { width: 80px; }
.nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; border-radius: 12px; transition: all 0.2s; color: #94a3b8; }
.nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
.nav-link.active { background: #10b981; color: white; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); }
#main-content { transition: all 0.3s ease; margin-left: 260px; }
#main-content.expanded { margin-left: 80px; }
@media (max-width: 768px) { 
    #sidebar { transform: translateX(-100%); }
    #sidebar.open { transform: translateX(0); }
    #main-content { margin-left: 0 !important; }
}
    </style>
</head>
<body class="pb-20">
<button onclick="toggleMobileMenu()" class="fixed top-4 right-4 z-[1100] md:hidden bg-emerald-600 text-white p-3 rounded-xl shadow-lg">
    <i class="fas fa-bars"></i>
</button>

<aside id="sidebar" class="fixed inset-y-0 left-0 bg-slate-900 text-slate-300 flex flex-col p-4 shadow-2xl">
    <div class="flex items-center gap-3 px-2 mb-10 mt-2">
        <div class="bg-emerald-500 text-white p-2 rounded-lg">
            <i class="fas fa-hospital-user"></i>
        </div>
        <div class="sidebar-text">
            <h2 class="text-white font-bold leading-none">PKM Kiarapedes</h2>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Digital Hub</p>
        </div>
    </div>

    <nav class="flex flex-col gap-2 flex-grow">
        <p class="text-[10px] font-bold text-slate-600 uppercase px-4 mb-2 sidebar-text">Main Menu</p>
        
        <a href="index.html" class="nav-link">
            <i class="fas fa-th-large w-5"></i>
            <span class="sidebar-text">Dashboard</span>
        </a>

        <a href="simpeg.html" id="link-simpeg" class="nav-link">
            <i class="fas fa-user-tie w-5"></i>
            <span class="sidebar-text">SIMPEG</span>
        </a>

        <a href="e-arsip.html" id="link-arsip" class="nav-link">
            <i class="fas fa-folder-open w-5"></i>
            <span class="sidebar-text">E-Arsip</span>
        </a>

        <a href="analisis.html" id="link-analisis" class="nav-link">
            <i class="fas fa-chart-line w-5"></i>
            <span class="sidebar-text">Analisis Data</span>
        </a>
    </nav>

    <div class="mt-auto p-2 bg-slate-800/50 rounded-2xl sidebar-text text-center">
        <p class="text-[10px] text-slate-400">v2.1 Stable</p>
    </div>
</aside>
    
    <div id="loginPage" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 p-10 rounded-[3rem] shadow-2xl w-full max-w-sm text-center">
        <div class="w-20 h-20 bg-emerald-500 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-emerald-500/20">
            <i class="fas fa-user-shield text-3xl"></i>
        </div>
        <h2 class="text-2xl font-black dark:text-white uppercase tracking-tighter">Login</h2>
        <p class="text-[10px] text-slate-400 mb-8 font-bold uppercase tracking-widest">Analisis Data PKM Kiarapedes</p>
        <input type="text" id="userInput" placeholder="Username" class="w-full px-6 py-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-2xl outline-none border-2 border-transparent focus:border-emerald-500 text-center font-bold mb-3">
        <input type="password" id="passInput" placeholder="Password" class="w-full px-6 py-4 bg-slate-100 dark:bg-slate-700 dark:text-white rounded-2xl outline-none border-2 border-transparent focus:border-emerald-500 text-center font-bold mb-4">
        <button onclick="handleLogin()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs hover:bg-emerald-700 transition-all">Masuk Sistem</button>
    </div>
</div>

    <div id="mainApp" style="display: none;">
        <nav class="p-6 sticky top-0 z-50 bg-inherit backdrop-blur-md border-b border-white/5 flex justify-between items-center no-print">
            <div class="flex items-center gap-4">
                <div class="bg-emerald-500 p-2 rounded-xl text-slate-900 shadow-lg"><i class="fas fa-microchip"></i></div>
                <div>
                    <h1 class="text-lg font-black uppercase leading-none">Smart Dashboard <span class="text-emerald-500">PWS</span></h1>
                    <p class="text-[9px] font-bold opacity-50 uppercase tracking-widest">Reconciliation & Strategy Engine</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="bg-white/10 p-3 rounded-xl hover:bg-emerald-500 transition-all"><i id="themeIcon" class="fas fa-moon"></i></button>
                <button onclick="exportLaporanPDF()" class="bg-rose-600 text-white px-5 py-2.5 rounded-xl font-black text-[10px] uppercase flex items-center gap-2"><i class="fas fa-print"></i> PDF</button>
            </div>
        </nav>

        <main class="container mx-auto px-6 mt-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 no-print text-center">
                <div onclick="document.getElementById('fileAsik').click()" class="glass p-8 border-2 border-dashed border-blue-500/30 hover:bg-blue-500/5 cursor-pointer">
                    <input type="file" id="fileAsik" class="hidden" accept=".xlsx, .xls" onchange="handleFileUpload(this, 'asik')">
                    <i class="fas fa-database text-blue-500 text-3xl mb-3"></i>
                    <h4 class="text-xs font-black uppercase">Import Data ASIK</h4>
                </div>
                <div onclick="document.getElementById('fileEpus').click()" class="glass p-8 border-2 border-dashed border-emerald-500/30 hover:bg-emerald-500/5 cursor-pointer">
                    <input type="file" id="fileEpus" class="hidden" accept=".xlsx, .xls" onchange="handleFileUpload(this, 'epus')">
                    <i class="fas fa-hospital-user text-emerald-500 text-3xl mb-3"></i>
                    <h4 class="text-xs font-black uppercase">Import e-Puskesmas</h4>
                </div>
            </div>

            <div id="printArea">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="glass p-6 border-b-4 border-blue-500 text-center">
                        <p class="text-[9px] font-black opacity-50 uppercase mb-1">Capaian ASIK</p>
                        <h2 id="statAsik" class="text-3xl font-black text-blue-500">0</h2>
                    </div>
                    <div class="glass p-6 border-b-4 border-emerald-500 text-center">
                        <p class="text-[9px] font-black opacity-50 uppercase mb-1">Capaian e-PKM</p>
                        <h2 id="statEpus" class="text-3xl font-black text-emerald-500">0</h2>
                    </div>
                    <div class="glass p-6 border-b-4 border-amber-500 text-center">
                        <p class="text-[9px] font-black opacity-50 uppercase mb-1">Selisih Data</p>
                        <h2 id="totalPending" class="text-3xl font-black text-amber-500">0</h2>
                    </div>
                    <div class="glass p-6 border-b-4 border-rose-500 text-center">
                        <p class="text-[9px] font-black opacity-50 uppercase mb-1">Realisasi Keuangan</p>
                        <h2 id="statBudget" class="text-xl font-black text-rose-500">Rp 0</h2>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-2 glass p-8">
                        <h3 class="text-xs font-black opacity-50 uppercase mb-6">Visualisasi Sinkronisasi</h3>
                        <div class="h-80"><canvas id="chartComparison"></canvas></div>
                    </div>
                    <div class="glass p-8">
                        <h3 class="text-xs font-black text-blue-500 uppercase mb-6">Top 5 ICD-10 (Klinis)</h3>
                        <div id="icdList" class="space-y-3"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass p-8 border-l-8 border-emerald-500 bg-emerald-500/5">
                        <h3 class="text-xs font-black text-emerald-500 uppercase mb-6"><i class="fas fa-robot mr-2"></i>AI Strategic Evaluation (RTL)</h3>
                        <div id="aiEvaluation" class="text-[11px] leading-relaxed opacity-80"></div>
                    </div>
                    <div class="glass p-8 overflow-hidden">
                        <h3 class="text-xs font-black text-amber-500 uppercase mb-6"><i class="fas fa-bell mr-2"></i>Discrepancy Alerts</h3>
                        <div id="validationLog" class="space-y-4 max-h-[300px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

const _supabase = supabase.createClient('https://vxcgontdprrnotipdstx.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Y2dvbnRkcHJybm90aXBkc3R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDU3NzUsImV4cCI6MjA4NTc4MTc3NX0.LgMMA5ysutL4sgHCDWZea20gvv9hwRQHPAX2BougW1U');

// Cek apakah user sudah login
async function checkUser() {
    const { data: { user } } = await _supabase.auth.getUser();
    if (!user) {
        // Jika tidak ada user, tendang kembali ke halaman login
        window.location.href = 'login.html';
    }
}
checkUser();

    <script>
        const WILAYAH = ["KIARAPEDES", "GAROKGEK", "CIBEBER", "MARGALUYU", "CIRACAS", "PARAKAN GAROKGEK"];
        const KONTAK = { "KIARAPEDES": "628xxx", "GAROKGEK": "628xxx", "CIBEBER": "628xxx", "MARGALUYU": "628xxx", "CIRACAS": "628xxx", "PARAKAN GAROKGEK": "628xxx" };
        const BUDGET = { total: 500000000, realisasi: 325000000 };
        let DATA_ASIK = {}, DATA_EPUS = {}, chartObj = null;

        // AUTH
        document.getElementById('passInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleLogin(); });
       function handleLogin() {
    const user = document.getElementById('userInput').value;
    const pass = document.getElementById('passInput').value;
    // Default: admin / pkp123
    if(user === 'admin' && pass === 'pkp123') {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        initDashboard();
        alert("Selamat datang, " + user.toUpperCase());
    } else {
        alert("Username atau Password Salah!");
    }
}
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const icon = document.getElementById('themeIcon');
            icon.className = document.documentElement.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        }

        function initDashboard() {
            document.getElementById('statBudget').innerText = "Rp " + BUDGET.realisasi.toLocaleString('id-ID');
        }

        function handleFileUpload(input, type) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                const result = { total: 0, desa: {}, icd: {} };
                WILAYAH.forEach(w => result.desa[w] = 0);

                json.forEach(row => {
                    const rowText = Object.values(row).join(" ").toUpperCase();
                    const count = parseInt(row['Jumlah'] || row['Capaian'] || 1);
                    WILAYAH.forEach(w => { if(rowText.includes(w)) result.desa[w] += count; });
                    
                    const diag = row['Diagnosis'] || row['Nama Penyakit'];
                    if(diag && type === 'epus') result.icd[diag] = (result.icd[diag] || 0) + 1;
                    result.total += count;
                });

                if(type === 'asik') { DATA_ASIK = result; alert("Data ASIK Tersinkron!"); }
                else { DATA_EPUS = result; alert("Data e-PKM Tersinkron!"); }
                renderAnalysis(result.icd);
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function renderAnalysis(icdData) {
            const ctx = document.getElementById('chartComparison').getContext('2d');
            const log = document.getElementById('validationLog');
            log.innerHTML = "";
            let pending = 0;

            const dAsik = WILAYAH.map(w => DATA_ASIK.desa ? DATA_ASIK.desa[w] : 0);
            const dEpus = WILAYAH.map(w => DATA_EPUS.desa ? DATA_EPUS.desa[w] : 0);

            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: WILAYAH,
                    datasets: [
                        { label: 'ASIK', data: dAsik, backgroundColor: '#3b82f6', borderRadius: 8 },
                        { label: 'e-PKM', data: dEpus, backgroundColor: '#10b981', borderRadius: 8 }
                    ]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10 } } } } }
            });

            WILAYAH.forEach((desa, i) => {
                const diff = dEpus[i] - dAsik[i];
                if(diff > 0) {
                    pending += diff;
                    log.insertAdjacentHTML('beforeend', `
                        <div class="p-4 rounded-2xl bg-amber-500/10 border border-amber-500/20 flex justify-between items-center">
                            <div><p class="text-[10px] font-black uppercase">${desa}</p><p class="text-[9px] opacity-60">Pending: ${diff} data</p></div>
                            <button onclick="kirimWA('${desa}', ${diff})" class="bg-emerald-600 px-3 py-1.5 rounded-lg text-[8px] font-black uppercase text-white">WA Tagih</button>
                        </div>
                    `);
                }
            });

            // ICD-10
            if(icdData) {
                const top5 = Object.entries(icdData).sort((a,b)=>b[1]-a[1]).slice(0,5);
                document.getElementById('icdList').innerHTML = top5.map(([n,v]) => `<div class="flex justify-between border-b border-white/5 pb-2 text-[10px] font-bold uppercase"><span>${n.substring(0,25)}</span><span class="text-blue-500">${v}</span></div>`).join('');
                
                // AI EVALUATION
                const topDiag = top5[0] ? top5[0][0] : "N/A";
                const budRemaining = BUDGET.total - BUDGET.realisasi;
                document.getElementById('aiEvaluation').innerHTML = `
                    <div class="space-y-3">
                        <p><i class="fas fa-check-circle text-emerald-500"></i> Ditemukan <b class="text-white">${pending} data</b> e-PKM yang belum masuk ASIK. Hal ini menghambat pelaporan bulanan.</p>
                        <p><i class="fas fa-info-circle text-blue-500"></i> Penyakit <b class="text-white">${topDiag}</b> menjadi tren tertinggi. Disarankan alokasi anggaran promotif untuk pencegahan.</p>
                        <div class="p-3 bg-white/5 rounded-xl">
                            <p class="font-black text-white mb-1 uppercase text-[9px]">Rencana Tindak Lanjut (RTL):</p>
                            <ul class="list-decimal ml-4 space-y-1 opacity-70">
                                <li>Segera selesaikan input ASIK untuk desa dengan selisih tinggi.</li>
                                <li>Optimalkan sisa anggaran Rp ${budRemaining.toLocaleString()} untuk sosialisasi ${topDiag}.</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            document.getElementById('statAsik').innerText = DATA_ASIK.total || 0;
            document.getElementById('statEpus').innerText = DATA_EPUS.total || 0;
            document.getElementById('totalPending').innerText = pending;
        }

        function kirimWA(desa, selisih) {
            const pesan = `Halo Rekan *Desa ${desa}*, hasil audit sistem menunjukkan ada *${selisih} data* e-PKM yang belum terinput ke ASIK. Mohon segera divalidasi. Terima kasih.`;
            window.open(`https://wa.me/${KONTAK[desa]}?text=${encodeURIComponent(pesan)}`, '_blank');
        }

        function exportLaporanPDF() {
            const el = document.getElementById('printArea');
            html2pdf().set({ margin: 10, filename: 'Laporan_Eksekutif_PWS.pdf', jsPDF: { orientation: 'landscape' } }).from(el).save();
        }
        // Script untuk menandai halaman aktif dan toggle menu
function initNav() {
    const path = window.location.pathname;
    const page = path.split("/").pop();
    
    if (page === "simpeg.html") document.getElementById('link-simpeg').classList.add('active');
    if (page === "e-arsip.html") document.getElementById('link-arsip').classList.add('active');
    if (page === "analisis.html") document.getElementById('link-analisis').classList.add('active');
}

function toggleMobileMenu() {
    document.getElementById('sidebar').classList.toggle('open');
}

document.addEventListener('DOMContentLoaded', initNav);
    </script>
</body>

</html>
