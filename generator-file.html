<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Profil Kesehatan Digital</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --main-dark: #333; --accent-color: #2e7d32; }
        body { background-color: #f4f4f9; font-family: "Segoe UI", Arial, sans-serif; padding: 20px; }

        /* --- Overlay Login --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #212529; z-index: 9999; 
            display: flex; justify-content: center; align-items: center;
        }

        /* --- Layout Dokumen --- */
        #pdf-content {
            background: white;
            max-width: 900px;
            min-height: 1000px;
            padding: 40px 60px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            color: var(--main-dark);
        }

        .report-header {
            text-align: left;
            border-bottom: 2px solid #eee;
            margin-bottom: 30px;
            padding-bottom: 10px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-top: 25px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #f0f0f0;
        }

        .chart-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-top: 20px; }
        
        .pj-photo { 
            width: 80px; 
            height: auto;
            border-radius: 10px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        /* Tombol Panel */
        .control-panel { max-width: 900px; margin: 0 auto 20px auto; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card p-4 shadow" style="width: 320px; border-radius: 15px;">
        <h5 class="fw-bold text-center mb-3">Sistem Profil Kesehatan</h5>
        <input type="password" id="passInput" class="form-control mb-3" placeholder="Kata Sandi">
        <button onclick="cekLogin()" class="btn btn-dark w-100 fw-bold">Masuk</button>
    </div>
</div>

<div class="container control-panel">
    <div class="card p-4 border-0 shadow-sm">
        <div class="row g-3">
            <div class="col-md-7">
                <label class="fw-bold small mb-1">Catatan/Narasi Kesehatan:</label>
                <textarea id="rawInput" class="form-control" rows="6" placeholder="Tulis data di sini..."></textarea>
            </div>
            <div class="col-md-5">
                <label class="fw-bold small mb-1">API Key OpenAI:</label>
                <input type="password" id="apiKey" class="form-control mb-2" placeholder="sk-...">
                <div class="d-grid gap-2">
                    <button onclick="prosesAI()" class="btn btn-success fw-bold">PROSES OTOMATIS âœ¨</button>
                    <button onclick="downloadPDF()" class="btn btn-outline-dark">UNDUH PDF ðŸ“„</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pdf-content">
    <div class="report-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="fw-bold mb-0">LAPORAN PROFIL KESEHATAN</h4>
            <p class="text-muted small mb-0" id="currentDate"></p>
        </div>
        <div style="font-size: 0.8rem; color: #999;">Internal Use Only</div>
    </div>

    <div id="textOutput">
        <p class="text-center text-muted py-5">Belum ada data yang diproses.</p>
    </div>

    <div id="chartSection" style="display:none;" class="chart-box">
        <div class="fw-bold small mb-3 text-muted">VISUALISASI CAPAIAN DATA</div>
        <div style="height: 250px;">
            <canvas id="autoChart"></canvas>
        </div>
    </div>
</div>

<script>
    const databaseFoto = {
        "Default": "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgIu1TdCafyEoDbPpLt_kHzSW-YGMsMcNy16H7nVoudqsKQe9dHsRT1Yuy46C6rxyyWFRAxAFiddG5vj7TA1_ChbkJdCq9Veqeb3w7xX2mbv2wk1VMzgzLlRQdCheOAsBWARXBfByTCrxoOESF6hcpARCzRrsQ4ODzGa8rKC5mpxUjLb-c9vcpLCEyPwAVw/s320/buat-jadi-karikatur.jpeg"
    };

    let myChart = null;

    function cekLogin() {
        if(document.getElementById('passInput').value === "PUSKESMAS2026") {
            sessionStorage.setItem('isLoggedIn', 'true');
            document.getElementById('loginOverlay').style.display = 'none';
        }
    }

    async function prosesAI() {
        const text = document.getElementById('rawInput').value;
        const key = document.getElementById('apiKey').value;
        if(!key) return alert("Masukkan API Key!");

        // Simpan API Key agar tidak ngetik ulang
        localStorage.setItem('savedApiKey', key);

        document.getElementById('textOutput').innerHTML = "<p class='text-center py-5'>AI sedang menganalisis data...</p>";

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [{
                        role: "system",
                        content: "Strukturkan teks ini menjadi laporan kesehatan yang rapi. JSON output: {kategori: {Judul: [poin]}, ringkasan: string, data_grafik: {label: [string], nilai: [number]}}"
                    }, { role: "user", content: text }]
                })
            });

            const rawData = await response.json();
            const aiData = JSON.parse(rawData.choices[0].message.content);
            renderCleanStyle(aiData);
        } catch (e) { 
            alert("Gagal memproses. Pastikan API Key valid.");
            document.getElementById('textOutput').innerHTML = "";
        }
    }

    function renderCleanStyle(data) {
        let html = `<div class="mb-4"><p><strong>Ringkasan:</strong> ${data.ringkasan}</p></div>`;
        
        for (let cat in data.kategori) {
            html += `
                <div class="section-title">${cat}</div>
                <div class="d-flex align-items-start mb-3">
                    <ul class="flex-grow-1 ps-3 mb-0" style="font-size: 0.95rem;">
                        ${data.kategori[cat].map(p => `<li class="mb-1">${p}</li>`).join('')}
                    </ul>
                    <img src="${databaseFoto['Default']}" class="pj-photo">
                </div>`;
        }
        document.getElementById('textOutput').innerHTML = html;
        document.getElementById('chartSection').style.display = 'block';
        updateChart(data.data_grafik.label, data.data_grafik.nilai);
    }

    function updateChart(labels, values) {
        const ctx = document.getElementById('autoChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Persentase (%)', data: values, backgroundColor: '#2e7d32', borderRadius: 4 }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        const opt = {
            margin: 10,
            filename: 'Laporan_Kesehatan_Rapi.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    window.onload = () => {
        if(sessionStorage.getItem('isLoggedIn') === 'true') document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // Auto-fill API Key jika pernah disimpan
        const savedKey = localStorage.getItem('savedApiKey');
        if(savedKey) document.getElementById('apiKey').value = savedKey;
    };
</script>

</body>
</html>
