<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Arsip & Surat Tugas | PKM Kiarapedes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: #1e293b; }
        .glass-header { background: linear-gradient(135deg, #064e3b 0%, #059669 100%); }
        .card-custom { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; }
        .input-modern { width: 100%; padding: 0.75rem 1rem; background: #f1f5f9; border: 2px solid transparent; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; outline: none; transition: 0.2s; }
        .input-modern:focus { border-color: #10b981; background: white; }
        .tab-active { background: #10b981 !important; color: white !important; }
        .stat-card { background: white; padding: 1rem; border-radius: 1rem; border: 1px solid #e2e8f0; text-align: center; }
    </style>
</head>
<body>

<header class="glass-header text-white pb-32">
    <div class="container mx-auto px-6 pt-10">
        <h1 class="font-black text-2xl tracking-tighter italic uppercase">E-Arsip <span class="text-emerald-400">Digital</span></h1>
        <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-emerald-300">UPTD PUSKESMAS KIARAPEDES</p>
    </div>
</header>

<main class="container mx-auto px-6 -mt-24 pb-20">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8" id="statContainer"></div>

    <div class="flex gap-2 mb-6">
        <button onclick="switchTab('arsip')" id="btn-tab-arsip" class="tab-link tab-active px-6 py-3 rounded-2xl font-black text-[10px] uppercase shadow-md">Manajemen Arsip</button>
        <button onclick="switchTab('tugas')" id="btn-tab-tugas" class="tab-link bg-white text-slate-500 px-6 py-3 rounded-2xl font-black text-[10px] uppercase shadow-md">Buat Surat Tugas</button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4">
            <div id="pane-arsip" class="pane card-custom p-6 shadow-xl sticky top-6">
                <h3 class="text-xs font-black uppercase text-emerald-600 mb-6 italic">Input Arsip Baru</h3>
                <form id="formArsip" class="space-y-4">
                    <select id="selKlaster" class="input-modern" onchange="updateSub()"></select>
                    <select id="selSub" class="input-modern"></select>
                    <input type="text" id="arsipNama" placeholder="Judul Dokumen / Perihal" class="input-modern" required>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="arsipTgl" class="input-modern" required>
                        <select id="arsipTipe" class="input-modern">
                            <option value="Masuk">Surat Masuk</option>
                            <option value="Keluar">Surat Keluar</option>
                        </select>
                    </div>
                    <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 text-center">
                        <input type="file" id="arsipFile" class="hidden" onchange="updateFileName()">
                        <label for="arsipFile" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-emerald-500 text-xl mb-1"></i>
                            <p id="fileNameDisplay" class="text-[9px] font-bold text-slate-400 uppercase">Lampirkan File</p>
                        </label>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase text-xs">Simpan ke Cloud</button>
                </form>
            </div>

            <div id="pane-tugas" class="pane hidden card-custom p-6 shadow-xl sticky top-6">
                <h3 class="text-xs font-black uppercase text-indigo-600 mb-6 italic">Buat Surat Tugas</h3>
                <div class="space-y-4">
                    <input type="text" id="stNo" placeholder="Nomor Urut (Contoh: 001)" class="input-modern">
                    <select id="selPegawai" class="input-modern" onchange="tambahPetugas()"></select>
                    <div id="boxPetugas" class="p-3 bg-slate-50 rounded-xl space-y-2 border border-dashed min-h-[50px]"></div>
                    <input type="text" id="stTujuan" placeholder="Tempat Tujuan" class="input-modern">
                    <input type="date" id="stTgl" class="input-modern">
                    <textarea id="stMaksud" placeholder="Maksud Tugas" class="input-modern h-20"></textarea>
                    <button onclick="cetakSuratTugas()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black uppercase text-xs">Cetak PDF Sesuai Template</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-4">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari arsip berdasarkan judul, klaster, atau file..." class="w-full pl-12 pr-4 py-4 rounded-2xl shadow-md outline-none focus:ring-2 focus:ring-emerald-500 font-semibold text-sm border-none">
            </div>

            <div class="card-custom overflow-hidden shadow-lg">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b">
                        <tr class="text-[10px] uppercase font-bold text-slate-500">
                            <th class="p-4 text-left">Tanggal</th>
                            <th class="p-4 text-left">Klaster</th>
                            <th class="p-4 text-left">Judul</th>
                            <th class="p-4 text-left">File</th>
                            <th class="p-4 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
// KONFIGURASI DATA
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyPuME9g05BtTN-ME-rXdzsSdbRz4_ZuBRfePuDaLLVnVH_z9mBkQSMBl4oVEEGqK_1RA/exec"; 
const SECRET_TOKEN = localStorage.getItem('PKM_KPDS_SECURE');
let db = [];
let editId = null;
let charts = { line: null, pie: null };

if (!SECRET_TOKEN) { window.location.href = 'index.html'; } else { loadFromCloud(); }

async function loadFromCloud() {showLoading(true);try {
const res = await fetch(`${WEB_APP_URL}?token=${SECRET_TOKEN}`);
const data = await res.json();
db = Array.isArray(data) ? data : [];
renderTable();
updateStats();
} catch (e) { alert("Error: Gagal terhubung ke Cloud"); }
showLoading(false);
}

    
const LOGO_KAB = "data:image/png;base64,..."; // Gunakan base64 dari file Logo Kabupaten PNG.txt
const LOGO_PKM = "data:image/png;base64,..."; // Gunakan base64 dari file Logo Puskesmas PNG.txt

const KLASTER = {
    "Klaster 1": ["Kepegawaian (800)", "Keuangan (900)", "Umum (060)"],
    "Klaster 2": ["KIA/Gizi (441)", "Kes Anak (441.5)"],
    "Klaster 3": ["Yankes (445)", "Kes Umum (440)"],
    "Klaster 4": ["P2P (443)", "Kesling (444)"],
    "Klaster 5": ["Farmasi (442)", "Laborat (445.4)"]
};

const DATA_PEGAWAI = [
    const DATA_PEGAWAI = [
    { nama: "Ajat Hermawan", nip: "198102202025211054", jabatan: "Operator Layanan Operasional" },
    { nama: "Anas Muhiban, S.E.", nip: "199703242025211057", jabatan: "Penata Layanan Operasional" },
    { nama: "apt. Herni Ekaraharjo, S. Farm", nip: "198509272023212004", jabatan: "Ahli Pertama - Apoteker" },
    { nama: "apt. Tria Wulandari P, S. Farm", nip: "199210082022032009", jabatan: "Apoteker Ahli Muda" },
    { nama: "Ardiansyah Astriadi, A. Md. AK", nip: "198907272022031007", jabatan: "Pranata Laboratorium Kesehatan Terampil" },
    { nama: "Ari Niken Palupi, Amd.Keb.", nip: "198501202017042001", jabatan: "Bidan Mahir" },
    { nama: "Barir Ismaya Shofa, A. Md.", nip: "199307252019032006", jabatan: "Perawat Gigi Pelaksana / Terampil" },
    { nama: "Ceceng Firmansyah", nip: "198405232025211107", jabatan: "Pengelola Umum Operasional" },
    { nama: "Cici Wijayanti, Amd.Keb", nip: "198608022024212010", jabatan: "Bidan Terampil" },
    { nama: "Cindyaningrum, Amd. Keb", nip: "199401272025212073", jabatan: "Bidan Terampil" },
    { nama: "Cucu Cuhayati, S.Tr. Keb.", nip: "199408202024212013", jabatan: "Bidan Terampil" },
    { nama: "Cucu Suminar, Amd.Kep", nip: "196804171989032007", jabatan: "Perawat Penyelia" },
    { nama: "Dewi Novianti, Amk", nip: "198311112023212003", jabatan: "Terampil - Perawat" },
    { nama: "Dewi Yuliani, AMK", nip: "199103132024212002", jabatan: "Perawat Terampil" },
    { nama: "Dika Megianty Agustin, S.M.", nip: "199708222025212061", jabatan: "Penata Layanan Operasional" },
    { nama: "Dodo Widodo", nip: "198410122025211067", jabatan: "Operator Layanan Operasional" },
    { nama: "dr. Anna Mardyana", nip: "198606172023212005", jabatan: "Ahli Pertama - Dokter" },
    { nama: "dr. Hendric Hariansyah, M.K.M", nip: "199603282022031009", jabatan: "Dokter Ahli Muda" },
    { nama: "dr. Rizki Prasetyo", nip: "123456789101112134", jabatan: "Dokter Umum" },
    { nama: "dr. Zakariya", nip: "197509222006041007", jabatan: "Dokter Ahli Madya" },
    { nama: "drg. Fitri Nurzanah", nip: "199902032025062009", jabatan: "Dokter Gigi Ahli Pertama" },
    { nama: "Eka Prisna Nengsih, Amd. Kep", nip: "199605152025212081", jabatan: "Perawat Terampil" },
    { nama: "Garry Rachman, Amd.Kep", nip: "198509132025211002", jabatan: "Perawat Terampil" },
    { nama: "H. Ujang Sutrisna, S. Kep., Ners., M. Kep.", nip: "197707132006041011", jabatan: "Kepala Puskesmas Kiarapedes" },
    { nama: "Harbangkit Rizki, Amd. Kes", nip: "199605202022031014", jabatan: "Perekam Medis Terampil" },
    { nama: "Haris Ridwansyah, S. Kep. Ners.", nip: "198105202008011004", jabatan: "Perawat Penyelia" },
    { nama: "Imas Teti Sugiharti, Amd.Keb", nip: "198702172017042001", jabatan: "Bidan Mahir" },
    { nama: "Irma Septiani, Amd. Keb.", nip: "199309082025212079", jabatan: "Bidan Terampil" },
    { nama: "Juwita Pebrara, Amd. Keb.", nip: "199002092024212007", jabatan: "Bidan Terampil" },
    { nama: "Kartikasari, Amd. Keb", nip: "199504232025212088", jabatan: "Bidan Terampil" },
    { nama: "Komariah, Amd.Keb.", nip: "198208202023212002", jabatan: "Terampil - Bidan" },
    { nama: "Lusi Fitriyani Caturmawati, A. Md. Farm", nip: "199104132022032013", jabatan: "Asisten Apoteker Terampil" },
    { nama: "Marina, Amd. Keb", nip: "199303052025212078", jabatan: "Bidan Terampil" },
    { nama: "Merri Diana, S.Tr. Keb.", nip: "197205122006042012", jabatan: "Bidan Penyelia" },
    { nama: "Mimah Nurhalimah, Amd.Keb", nip: "199106152025212098", jabatan: "Bidan Terampil" },
    { nama: "Muhamad Haris Romdoni, AMK.", nip: "199502052024211005", jabatan: "Perawat Terampil" },
    { nama: "Neni Supriyani, Amk", nip: "198204192008012006", jabatan: "Perawat Penyelia" },
    { nama: "Nining", nip: "198204072025212053", jabatan: "Operator Layanan Operasional" },
    { nama: "Popy Hasanah, Amd. AK", nip: "199812292024212009", jabatan: "Pranata Laboratorium Kesehatan Terampil" },
    { nama: "Rahayu Ratnasari, Amg", nip: "199103232019032003", jabatan: "Nutrisionis Mahir" },
    { nama: "Ratna Dewi, Amd.Keb", nip: "199101142024212015", jabatan: "Bidan Terampil" },
    { nama: "Rizki Rangga Triyana, A.Md. Kep.", nip: "198903012019031002", jabatan: "Perawat Mahir" },
    { nama: "Rohman", nip: "198610292025211068", jabatan: "Operator Layanan Operasional" },
    { nama: "Rudi Subarkat, S. Kep", nip: "199109232023211003", jabatan: "Terampil - Perawat" },
    { nama: "Samirah, Amd. Keb.", nip: "198905312024212002", jabatan: "Tenaga Promosi Kesehatan Dan Ilmu Perilaku Terampil" },
    { nama: "Siska Apriliani, Amd. Keb.", nip: "199804132024212005", jabatan: "Bidan Terampil" },
    { nama: "Siswinarti, S.Kep. Ners.", nip: "198204272009022005", jabatan: "Perawat Ahli Pertama" },
    { nama: "Siti Fatimah, Amk", nip: "199108042024212012", jabatan: "Perawat Terampil" },
    { nama: "Siti Rohmah, AMK", nip: "198306252008012002", jabatan: "Perawat Penyelia" },
    { nama: "Sri Endang Sukmayati", nip: "200206012025212009", jabatan: "Operator Layanan Operasional" },
    { nama: "Sri Sumarti, SKM", nip: "197503232006042021", jabatan: "Bidan Pelaksana Lanjutan / Mahir" },
    { nama: "Susilawati, Amd.Keb.", nip: "198404062019032004", jabatan: "Bidan Mahir" },
    { nama: "Tanti Kemalasari, Amd.Farm.", nip: "199511192024212009", jabatan: "Asisten Apoteker Terampil" },
    { nama: "Tating Kusmiati, Amd. Keb.", nip: "199310112024212011", jabatan: "Bidan Terampil" },
    { nama: "Tika Ayu Lestari, Amd. Keb.", nip: "199402012025212076", jabatan: "Bidan Terampil" },
    { nama: "Tita Rosmiati, Amd.Keb", nip: "197608182006042023", jabatan: "Bidan Pelaksana Lanjutan / Mahir" },
    { nama: "Titin Sutinah, Amd. Keb", nip: "197701212006042012", jabatan: "Bidan Mahir" },
    { nama: "Tika Azlia Rachmawati, Amd.Kes", nip: "200209092025062007", jabatan: "Tenaga Sanitasi Lingkungan Terampil" },
    { nama: "Ujang Kartono", nip: "198103222009011001", jabatan: "Pengadministrasi Umum" },
    { nama: "Vivit Nopiyanti, Amd.Keb.", nip: "198411042017042001", jabatan: "Bidan Mahir" },
    { nama: "Widya Kusumawati, S.E.", nip: "199708152025212066", jabatan: "Penata Layanan Operasional" },
    { nama: "Yeni Heryani", nip: "198510212025212047", jabatan: "Operator Layanan Operasional" }
];
    
let database = JSON.parse(localStorage.getItem('db_arsip')) || [];
let petugasDipilih = [];

window.onload = () => {
    const kSel = document.getElementById('selKlaster');
    Object.keys(KLASTER).forEach(k => kSel.innerHTML += `<option value="${k}">${k}</option>`);
    
    const pSel = document.getElementById('selPegawai');
    pSel.innerHTML = '<option value="">-- Pilih Nama Pegawai --</option>';
    DATA_PEGAWAI.forEach(p => pSel.innerHTML += `<option value="${p.nama}">${p.nama}</option>`);
    
    updateSub();
    renderTable();
};

// LOGIKA UI
function switchTab(t) {
    document.querySelectorAll('.pane').forEach(p => p.classList.add('hidden'));
    document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('tab-active', 'bg-white', 'text-slate-500'));
    document.getElementById('pane-' + t).classList.remove('hidden');
    document.getElementById('btn-tab-' + t).classList.add('tab-active');
}

function updateSub() {
    const k = document.getElementById('selKlaster').value;
    document.getElementById('selSub').innerHTML = KLASTER[k].map(s => `<option value="${s}">${s}</option>`).join('');
}

function updateFileName() {
    const f = document.getElementById('arsipFile').files[0];
    document.getElementById('fileNameDisplay').innerText = f ? f.name : "Lampirkan File";
}

// LOGIKA ARSIP & PENCARIAN
document.getElementById('formArsip').onsubmit = function(e) {
    e.preventDefault();
    const entry = {
        klaster: document.getElementById('selKlaster').value,
        nama: document.getElementById('arsipNama').value,
        tgl: document.getElementById('arsipTgl').value,
        file: document.getElementById('arsipFile').files[0]?.name || "Tanpa Lampiran"
    };
    database.push(entry);
    localStorage.setItem('db_arsip', JSON.stringify(database));
    renderTable();
    this.reset();
    alert("Berhasil disimpan!");
};

function renderTable() {
    const s = document.getElementById('searchInput').value.toLowerCase();
    const filtered = database.filter(i => i.nama.toLowerCase().includes(s) || i.klaster.toLowerCase().includes(s));
    
    document.getElementById('tableBody').innerHTML = filtered.reverse().map(x => `
        <tr class="border-b hover:bg-slate-50 transition-all">
            <td class="p-4 font-bold text-slate-500 text-xs">${x.tgl}</td>
            <td class="p-4"><span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-[9px] font-black">${x.klaster}</span></td>
            <td class="p-4 font-semibold uppercase text-xs">${x.nama}</td>
            <td class="p-4 text-blue-500 italic text-[10px]">${x.file}</td>
            <td class="p-4 text-center"><button class="text-slate-300 hover:text-emerald-500"><i class="fas fa-file-alt"></i></button></td>
        </tr>
    `).join('');
    renderStats();
}

function renderStats() {
    document.getElementById('statContainer').innerHTML = Object.keys(KLASTER).map(k => {
        const c = database.filter(i => i.klaster === k).length;
        return `<div class="stat-card shadow-sm"><p class="text-[8px] font-black text-slate-400 uppercase">${k}</p><p class="text-xl font-black text-emerald-600">${c}</p></div>`;
    }).join('');
}

// LOGIKA SURAT TUGAS
function tambahPetugas() {
    const n = document.getElementById('selPegawai').value;
    const p = DATA_PEGAWAI.find(x => x.nama === n);
    if(p && !petugasDipilih.some(x => x.nama === n)) {
        petugasDipilih.push(p);
        renderBoxPetugas();
    }
}

function renderBoxPetugas() {
    document.getElementById('boxPetugas').innerHTML = petugasDipilih.map((p, i) => `
        <div class="flex justify-between items-center bg-white p-2 rounded-lg border text-[10px] font-bold">
            <span>${p.nama}</span>
            <button onclick="petugasDipilih.splice(${i},1);renderBoxPetugas()" class="text-rose-500 font-black px-2">Ã—</button>
        </div>
    `).join('');
}

async function cetakSuratTugas() {
    if(petugasDipilih.length === 0) return alert("Pilih petugas!");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Header (Sesuai Template)
    doc.setFont("times", "bold").setFontSize(14);
    doc.text("PEMERINTAH KABUPATEN PURWAKARTA", 100, 15, {align:"center"});
    doc.text("DINAS KESEHATAN", 100, 21, {align:"center"});
    doc.setFontSize(16).text("UPTD PUSKESMAS KIARAPEDES", 100, 28, {align:"center"});
    doc.setFontSize(9).setFont("times", "normal");
    doc.text("Jalan Raya Kiarapedes No.2 Km. 28 Kecamatan Kiarapedes", 100, 33, {align:"center"});
    doc.text("Email : pkmkiarapedes20@gmail.com Kode Pos 41175", 100, 37, {align:"center"});
    doc.line(15, 40, 195, 40);
    doc.line(15, 41, 195, 41);
    
    // Nomor Surat
    const tgl = new Date(document.getElementById('stTgl').value);
    const romawi = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"][tgl.getMonth()];
    doc.setFont("times", "bold").setFontSize(12).text("SURAT TUGAS", 100, 50, {align:"center"});
    doc.setFont("times", "normal").text(`No: ${document.getElementById('stNo').value}/ST/PKM-KPDS/${romawi}/${tgl.getFullYear()}`, 100, 55, {align:"center"});

    // Tabel Petugas
    doc.autoTable({
        startY: 90,
        head: [['No', 'Nama', 'NIP', 'Jabatan']],
        body: petugasDipilih.map((p, i) => [i+1, p.nama, p.nip, p.jabatan]),
        theme: 'grid', styles: {font: "times"}
    });

    let y = doc.lastAutoTable.finalY + 10;
    doc.text(`Untuk: ${document.getElementById('stMaksud').value}`, 20, y);
    doc.text(`Tempat: ${document.getElementById('stTujuan').value}`, 20, y+8);

    doc.save(`Surat_Tugas_${document.getElementById('stNo').value}.pdf`);
}
</script>
</body>
</html>
