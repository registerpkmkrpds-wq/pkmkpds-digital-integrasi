<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Arsip | PKM Kiarapedes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        :root { --primary: #10b981; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; overflow-x: hidden; }
        .glass-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding-top: 6rem !important; }
        .card-custom { background: white; border-radius: 1.5rem; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); transition: 0.3s; }
        .input-modern { width: 100%; padding: 0.75rem 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; outline: none; transition: 0.2s; }
        .input-modern:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        .animate-fade { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="text-slate-900">

<div id="loading" class="hidden fixed inset-0 z-[9999] bg-emerald-600/95 backdrop-blur-md flex flex-col items-center justify-center text-white">
    <div class="w-12 h-12 border-4 border-white/30 border-t-white rounded-full animate-spin mb-4"></div>
    <p class="font-bold text-xs tracking-[0.3em] uppercase animate-pulse">Sinkronisasi Cloud...</p>
</div>

<div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] no-print w-max">
    <div class="bg-slate-900/90 backdrop-blur-xl p-2 rounded-2xl shadow-2xl border border-white/20 flex items-center gap-2">
        <a href="index.html" class="px-6 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wider text-white hover:text-emerald-400 transition-all flex items-center gap-2">
            <i class="fas fa-home"></i> Kembali ke Menu Utama
        </a>
    </div>
</div>

<header class="glass-header text-white pb-32 no-print">
    <div class="container mx-auto px-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div>
                <h1 class="font-black text-2xl uppercase tracking-tighter flex items-center gap-3">
                    <i class="fas fa-folder-tree text-emerald-400"></i> Arsip Digital
                </h1>
                <p class="text-[10px] font-bold uppercase tracking-[0.3em] text-emerald-400 mt-1">Sistem Administrasi PKM Kiarapedes</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <a href="https://puskesmaskiarapedes.blogspot.com/p/form-surat-tugas.html" target="_blank" class="bg-yellow-600 hover:bg-yellow-700 px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase border border-white/10 transition flex items-center gap-2 text-white decoration-0">
                    <i class="fa-solid fa-pen-to-square"></i> Buat Surat Tugas
                </a>
                <button onclick="openModal('agendaModal')" class="bg-blue-600 hover:bg-blue-700 px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase border border-white/10 transition flex items-center gap-2">
                    <i class="fas fa-inbox"></i> Surat Masuk
                </button>
                <button onclick="openModal('suratKeluarModal')" class="bg-rose-600 hover:bg-rose-700 px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase border border-white/10 transition flex items-center gap-2">
                    <i class="fas fa-paper-plane"></i> Surat Keluar
                </button>
                <div class="w-[1px] h-6 bg-white/10 mx-1 hidden md:block"></div>
                <button onclick="exportToPDF()" class="bg-emerald-600 hover:bg-emerald-700 px-5 py-2.5 rounded-xl font-bold text-[10px] uppercase border border-white/10 transition flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> Export Laporan
                </button>
            </div>
        </div>
        <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mt-10"></div>
    </div>
</header>

<main class="container mx-auto px-6 -mt-20 pb-24 animate-fade">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4">
            <div class="card-custom p-6 sticky top-6">
                <h3 id="formTitle" class="text-xs font-black uppercase tracking-widest text-slate-400 mb-6">Input Dokumen Baru</h3>
                <form id="docForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-2">
                        <select id="docGroup" class="input-modern" required>
                            <option value="A">GRUP A</option><option value="B">GRUP B</option><option value="C">GRUP C</option>
                            <option value="D">GRUP D</option><option value="E">GRUP E</option><option value="F">GRUP F</option>
                        </select>
                        <select id="docCatType" class="input-modern" required>
                            <option value="BA">Berita Acara (BA)</option><option value="SK">Surat Keputusan (SK)</option>
                            <option value="SOP">Prosedur (SOP)</option><option value="ST">Surat Tugas(ST)</option>
                            <option value="SKT">Surat Keterangan (SKT)</option><option value="SL">Surat Lainnya (SL)</option>
                            <option value="UND">Undangan (UND)</option><option value="DB">Dokumen Bukti (DB)</option>
                            <option value="DU">Dokumen Umum (DU)</option><option value="Vid">Video (Vid)</option>
                        </select>
                    </div>
                    <select id="inputKlaster" class="input-modern" required>
                        <option value="Klaster 1">Klaster 1: Manajemen</option>
                        <option value="Klaster 2">Klaster 2: Ibu & Anak</option>
                        <option value="Klaster 3">Klaster 3: Dewasa & Lansia</option>
                        <option value="Klaster 4">Klaster 4: Penanggulangan Penyakit</option>
                        <option value="Lintas Klaster">Lintas Klaster</option>
                    </select>
                    <select id="docStatus" class="input-modern">
                        <option value="Selesai">‚úÖ Selesai</option>
                        <option value="Proses">‚è≥ Proses</option>
                        <option value="Penting">üö® Penting</option>
                    </select>
                    <input type="text" id="docName" placeholder="Perihal Dokumen" class="input-modern" required>
                    <input type="url" id="docLink" placeholder="Link Drive (https://...)" class="input-modern">
                    <button type="submit" id="btnSubmit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-emerald-700 transition-all">Simpan Data</button>
                    <button type="button" id="btnCancel" onclick="cancelEdit()" class="hidden w-full bg-slate-100 text-slate-500 py-2 rounded-xl font-bold uppercase text-[10px] mt-2">Batal Edit</button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-8">
            <div class="card-custom p-4 bg-white no-print grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search" oninput="renderTable()" placeholder="Cari perihal/nomor..." 
                           class="w-full pl-11 pr-4 py-3 bg-slate-50 border-none rounded-xl outline-none font-semibold text-sm">
                </div>
                <select id="filterKlaster" onchange="renderTable()" class="input-modern">
                    <option value="">Semua Klaster</option>
                    <option value="Klaster 1">Klaster 1</option><option value="Klaster 2">Klaster 2</option>
                    <option value="Klaster 3">Klaster 3</option><option value="Klaster 4">Klaster 4</option>
                    <option value="Lintas Klaster">Lintas Klaster</option>
                </select>
                <select id="filterBulan" onchange="renderTable()" class="input-modern">
                    <option value="">Semua Bulan</option>
                    <option value="/01/">Januari</option><option value="/02/">Februari</option><option value="/03/">Maret</option>
                    <option value="/04/">April</option><option value="/05/">Mei</option><option value="/06/">Juni</option>
                    <option value="/07/">Juli</option><option value="/08/">Agustus</option><option value="/09/">September</option>
                    <option value="/10/">Oktober</option><option value="/11/">November</option><option value="/12/">Desember</option>
                </select>
            </div>

            <div class="card-custom overflow-hidden bg-white">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b text-[10px] text-slate-400 font-black uppercase">
                            <tr>
                                <th class="px-6 py-5">No. Arsip</th>
                                <th class="px-6 py-5">Detail</th>
                                <th class="px-6 py-5 text-center">Status</th>
                                <th class="px-6 py-5 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-50 text-xs font-semibold"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 no-print pt-4">
                <div class="card-custom p-6 bg-white">
                    <h4 class="text-[10px] font-black uppercase mb-6 text-slate-400">Penyebaran Grup</h4>
                    <div class="h-[200px]"><canvas id="pieChartGrup"></canvas></div>
                </div>
                <div class="card-custom p-6 bg-white">
                    <h4 class="text-[10px] font-black uppercase mb-6 text-slate-400">Status Dokumen</h4>
                    <div class="h-[200px]"><canvas id="barChartStatus"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="qrModal" class="fixed inset-0 z-[110] bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-[2.5rem] text-center max-w-xs w-full">
        <div id="qrcode" class="flex justify-center mb-6 p-4 border-4 border-slate-50 rounded-2xl"></div>
        <p id="qrTitle" class="text-xs font-bold text-slate-800 uppercase mb-6"></p>
        <button onclick="closeModal('qrModal')" class="w-full bg-slate-100 py-3 rounded-xl font-black text-[10px] uppercase">Tutup</button>
    </div>
</div>

<div id="agendaModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-[2rem] p-8">
        <h2 class="font-black text-xs uppercase mb-6 text-blue-600">Input Surat Masuk</h2>
        <div class="space-y-3">
            <input type="text" id="agAsal" placeholder="Asal Surat" class="input-modern">
            <input type="text" id="agPerihal" placeholder="Perihal" class="input-modern">
            <input type="url" id="agLink" placeholder="Link Drive" class="input-modern">
            <div class="flex gap-3 pt-4">
                <button onclick="closeModal('agendaModal')" class="flex-1 text-[10px] font-bold uppercase text-slate-400">Batal</button>
                <button onclick="alert('Sinkronisasi database Surat Masuk akan diproses oleh sistem.')" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-[10px] uppercase">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div id="suratKeluarModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-[2rem] p-8">
        <h2 class="font-black text-xs uppercase mb-6 text-rose-600">Input Surat Keluar</h2>
        <div class="space-y-3">
            <input type="text" id="skTujuan" placeholder="Tujuan" class="input-modern">
            <input type="text" id="skPerihal" placeholder="Perihal" class="input-modern">
            <div class="flex gap-3 pt-4">
                <button onclick="closeModal('suratKeluarModal')" class="flex-1 text-[10px] font-bold uppercase text-slate-400">Batal</button>
                <button onclick="alert('Nomor surat keluar akan segera terdaftar otomatis.')" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold text-[10px] uppercase">Simpan</button>
            </div>
        </div>
    </div>
</div>

<script>
<script>
// URL BARU ANDA SUDAH DIMASUKKAN
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyPuME9g05BtTN-ME-rXdzsSdbRz4_ZuBRfePuDaLLVnVH_z9mBkQSMBl4oVEEGqK_1RA/exec"; 
const SECRET_TOKEN = localStorage.getItem('pkm_token');
let db = [];
let editId = null;
let pieChart, barChart;

// PERBAIKAN LOGIKA PEMBUKAAN: 
// Jika gagal karena session, tetap jalankan load agar aplikasi tidak blank
async function init() {
    console.log("Memulai inisialisasi...");
    await loadFromCloud();
}

init(); // Jalankan langsung

async function loadFromCloud() {
    showLoading(true);
    try {
        // Menggunakan mode cors dan menyertakan token jika ada
        const response = await fetch(`${WEB_APP_URL}?token=${SECRET_TOKEN || ''}`);
        
        if (!response.ok) throw new Error("Network response was not ok");
        
        const data = await response.json();
        console.log("Data diterima:", data);
        
        db = Array.isArray(data) ? data.map(item => ({
            id: item.id || Date.now() + Math.random(),
            formatNo: item.formatNo || item.formatno || '---',
            n: item.n || 'Tanpa Judul',
            l: item.l || '',
            k: item.k || 'A',
            klaster: item.klaster || 'UMUM',
            status: item.status || 'Selesai',
            t: item.t || '-'
        })) : [];
        
        renderTable();
        updateCharts();
    } catch (e) { 
        console.error("Gagal load data:", e);
        // Jika data kosong/error, tetap tampilkan tabel kosong agar aplikasi tidak mati
        renderTable(); 
    }

async function loadFromCloud() {
    showLoading(true);
    try {
        const res = await fetch(`${WEB_APP_URL}?token=${SECRET_TOKEN}`);
        const data = await res.json();
        db = Array.isArray(data) ? data.map(item => ({
            id: item.id || Date.now(),
            formatNo: item.formatNo || item.formatno || '---',
            n: item.n || '',
            l: item.l || '',
            k: item.k || 'A',
            klaster: item.klaster || 'UMUM',
            status: item.status || 'Selesai',
            t: item.t || ''
        })) : [];
        renderTable();
        updateCharts();
    } catch (e) { console.error("Load Error:", e); }
    showLoading(false);
}

async function syncToCloud() {
    showLoading(true);
    try {
        await fetch(WEB_APP_URL, { 
            method: "POST", 
            mode: 'no-cors',
            body: JSON.stringify({ action: "saveAll", db: db, token: SECRET_TOKEN }) 
        });
        updateStats();
        updateCharts();
    } catch (e) { console.error("Sync Error:", e); }
    showLoading(false);
}

function renderTable() {
    const b = document.getElementById('tableBody');
    const s = document.getElementById('search').value.toLowerCase();
    const fK = document.getElementById('filterKlaster').value;
    const fB = document.getElementById('filterBulan').value;

    const filtered = db.filter(i => {
        const perihal = (i.n || "").toLowerCase();
        const noArsip = (i.formatNo || "").toLowerCase();
        return (perihal.includes(s) || noArsip.includes(s)) && 
               (fK === "" || i.klaster === fK) && 
               (fB === "" || i.t.includes(fB));
    });

    b.innerHTML = filtered.map(i => {
        const link = (i.l || "").trim();
        const stClass = i.status === 'Selesai' ? 'bg-blue-50 text-blue-600' : 
                        i.status === 'Penting' ? 'bg-rose-50 text-rose-600' : 'bg-amber-50 text-amber-600';
        
        return `
        <tr class="hover:bg-slate-50 transition-all">
            <td class="px-6 py-4 font-mono text-slate-500 font-bold">${i.formatNo}</td>
            <td class="px-6 py-4">
                <div class="font-bold text-slate-800 uppercase">${i.n}</div>
                <div class="text-[9px] text-slate-400 mt-1 uppercase">${i.t} | GRUP ${i.k} | <span class="text-emerald-600 font-bold">${i.klaster}</span></div>
            </td>
            <td class="px-6 py-4 text-center">
                <span class="text-[9px] font-black px-3 py-1 rounded-full uppercase ${stClass}">${i.status}</span>
            </td>
            <td class="px-6 py-4">
                <div class="flex justify-center gap-2">
                    ${link ? `<a href="${link}" target="_blank" class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white rounded-lg shadow-sm hover:scale-110 transition-transform"><i class="fas fa-external-link-alt text-[10px]"></i></a>` : ''}
                    <button onclick="showQR('${link}','${i.n}')" class="w-8 h-8 flex items-center justify-center ${link ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-gray-100 text-gray-300 cursor-not-allowed'} border rounded-lg"><i class="fas fa-qrcode text-[10px]"></i></button>
                    <button onclick="editData(${i.id})" class="w-8 h-8 flex items-center justify-center bg-amber-50 text-amber-600 rounded-lg border border-amber-100"><i class="fas fa-pen text-[10px]"></i></button>
                    <button onclick="delData(${i.id})" class="w-8 h-8 flex items-center justify-center bg-rose-50 text-rose-400 rounded-lg border border-rose-100 hover:bg-rose-500 hover:text-white transition-all"><i class="fas fa-trash-can text-[10px]"></i></button>
                </div>
            </td>
        </tr>`;
    }).join('');
    updateStats();
}

document.getElementById('docForm').onsubmit = async (e) => {
    e.preventDefault();
    const date = new Date();
    const romawi = ["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII"][date.getMonth()];
    const cat = document.getElementById('docCatType').value;

    if (editId) {
        const idx = db.findIndex(i => i.id === editId);
        if (idx !== -1) {
            db[idx].n = document.getElementById('docName').value;
            db[idx].l = document.getElementById('docLink').value;
            db[idx].k = document.getElementById('docGroup').value;
            db[idx].klaster = document.getElementById('inputKlaster').value;
            db[idx].status = document.getElementById('docStatus').value;
        }
        cancelEdit();
    } else {
        const sameCatDocs = db.filter(item => {
            const parts = (item.formatNo || "").split('/');
            return parts.length > 1 && parts[1] === cat;
        });
        let nextNo = 1;
        if (sameCatDocs.length > 0) {
            const numbers = sameCatDocs.map(item => parseInt(item.formatNo.split('/')[0])).filter(n => !isNaN(n));
            nextNo = numbers.length > 0 ? Math.max(...numbers) + 1 : 1;
        }
        const fullNo = `${nextNo.toString().padStart(3,'0')}/${cat}/PKM-KPDS/${romawi}/${date.getFullYear()}`;
        db.unshift({
            id: Date.now(),
            formatNo: fullNo,
            n: document.getElementById('docName').value,
            k: document.getElementById('docGroup').value,
            klaster: document.getElementById('inputKlaster').value,
            l: document.getElementById('docLink').value,
            status: document.getElementById('docStatus').value,
            t: date.toLocaleDateString('id-ID')
        });
    }
    renderTable();
    await syncToCloud();
    e.target.reset();
};

function editData(id) {
    const item = db.find(i => i.id === id);
    if(!item) return;
    editId = id;
    document.getElementById('docName').value = item.n;
    document.getElementById('docLink').value = item.l;
    document.getElementById('docGroup').value = item.k;
    document.getElementById('inputKlaster').value = item.klaster;
    document.getElementById('docStatus').value = item.status;
    document.getElementById('formTitle').innerText = "Edit Dokumen";
    document.getElementById('btnSubmit').innerText = "Update Data";
    document.getElementById('btnSubmit').classList.replace('bg-emerald-600', 'bg-amber-600');
    document.getElementById('btnCancel').classList.remove('hidden');
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function cancelEdit() {
    editId = null;
    document.getElementById('docForm').reset();
    document.getElementById('formTitle').innerText = "Input Dokumen Baru";
    document.getElementById('btnSubmit').innerText = "Simpan Data";
    document.getElementById('btnSubmit').classList.replace('bg-amber-600', 'bg-emerald-600');
    document.getElementById('btnCancel').classList.add('hidden');
}

function updateCharts() {
    const gData = ['A','B','C','D','E','F'].map(k => db.filter(i => i.k === k).length);
    const sData = ['Selesai','Proses','Penting'].map(s => db.filter(i => i.status === s).length);
    if(pieChart) pieChart.destroy();
    if(barChart) barChart.destroy();
    pieChart = new Chart(document.getElementById('pieChartGrup'), { type: 'doughnut', data: { labels: ['A','B','C','D','E','F'], datasets: [{ data: gData, backgroundColor: ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#ec4899'] }] }, options: { maintainAspectRatio: false } });
    barChart = new Chart(document.getElementById('barChartStatus'), { type: 'bar', data: { labels: ['Selesai','Proses','Penting'], datasets: [{ label: 'Jumlah', data: sData, backgroundColor: ['#3b82f6','#f59e0b','#ef4444'] }] }, options: { maintainAspectRatio: false } });
}

function updateStats() {
    const cats = ['TOTAL', 'A', 'B', 'C', 'D', 'E', 'F'];
    document.getElementById('statsContainer').innerHTML = cats.map(k => {
        const val = k === 'TOTAL' ? db.length : db.filter(i => i.k === k).length;
        return `<div class="bg-white/10 border border-white/10 p-4 rounded-2xl text-center backdrop-blur-md"><div class="text-[8px] font-black uppercase text-white/50 mb-1">${k}</div><div class="text-xl font-black text-white">${val}</div></div>`;
    }).join('');
}

async function delData(id) { if(confirm("Hapus data?")) { db = db.filter(i => i.id !== id); renderTable(); await syncToCloud(); } }
function showLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
function showQR(l, t) { if(!l) return alert('Link tidak ada'); document.getElementById("qrcode").innerHTML = ""; new QRCode(document.getElementById("qrcode"), { text: l, width: 140, height: 140 }); document.getElementById('qrTitle').innerText = t; openModal('qrModal'); }

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    doc.text("LAPORAN ARSIP DIGITAL PKM KIARAPEDES", 14, 15);
    doc.autoTable({ startY: 25, head: [['NO ARSIP', 'PERIHAL', 'KLASTER', 'STATUS', 'TANGGAL']], body: db.map(i => [i.formatNo, i.n.toUpperCase(), i.klaster, i.status, i.t]) });
    doc.save('Laporan_Arsip_PKM.pdf');
}
</script>
</body>
</html>
