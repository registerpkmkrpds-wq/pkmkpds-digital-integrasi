<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG Digital | PKM Kiarapedes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <style>
        /* Memastikan elemen asli Anda tetap terlihat bagus di tema gelap */
        body { background-color: #020617; color: #f1f5f9; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        input, select { background: rgba(0,0,0,0.2) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; padding: 10px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { color: #10b981; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: bold; border-radius: 12px; transition: 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <header class="glass-panel p-6 mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-tighter text-white uppercase">SIMPEG <span class="text-emerald-500 italic">DIGITAL</span></h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.3em]">PKM Kiarapedes Digital System</p>
            </div>
            <div class="text-right">
                <div id="clock" class="font-bold text-white"></div>
                <button onclick="window.location.href='index.html'" class="text-[10px] text-emerald-500 font-bold uppercase hover:underline">Kembali ke Menu</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 no-print">
                <div class="glass-panel p-8">
                    <h3 class="text-sm font-bold text-white mb-6 uppercase"><i class="fas fa-user-plus mr-2 text-emerald-500"></i> Input Pegawai</h3>
                    <form id="pegawaiForm" class="space-y-4">
                        <div class="flex items-center gap-4 mb-4">
                            <div id="imagePreview" class="w-12 h-12 rounded-lg bg-white/5 border border-dashed border-white/20 flex items-center justify-center text-white/20">
                                <i class="fas fa-camera"></i>
                            </div>
                            <input type="file" id="fotoPegawai" accept="image/*" class="text-[10px]">
                        </div>
                        <input type="text" id="namaPegawai" placeholder="Nama Lengkap" class="w-full" required>
                        <input type="text" id="nipPegawai" placeholder="NIP/NRPTK" class="w-full">
                        <input type="tel" id="waPegawai" placeholder="No. WA (62...)" class="w-full">
                        <select id="jabatanPegawai" class="w-full">
                            <option value="Medis">Tenaga Medis</option>
                            <option value="Paramedis">Tenaga Kesehatan</option>
                            <option value="Admin">Administrasi</option>
                            <option value="Umum">Umum</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-[9px] text-slate-500">Tgl Lahir</label><input type="date" id="tglLahir" class="w-full" required></div>
                            <div><label class="text-[9px] text-slate-500">SIP Deadline</label><input type="date" id="sipDeadline" class="w-full"></div>
                        </div>
                        <button type="submit" class="btn-primary w-full py-3">SIMPAN DATA</button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="glass-panel p-4 mb-6 flex items-center gap-4">
                    <i class="fas fa-search text-emerald-500 ml-2"></i>
                    <input type="text" id="searchInput" oninput="renderTable()" placeholder="Cari nama atau NIP..." class="flex-grow bg-transparent border-none outline-none">
                </div>

                <div class="glass-panel overflow-hidden">
                    <table id="pegawaiTable">
                        <thead>
                            <tr>
                                <th>Pegawai</th>
                                <th>Status Adm</th>
                                <th class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pegawaiTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="idCardModal" class="fixed inset-0 bg-black/90 z-[2000] hidden items-center justify-center">
        <div class="glass-panel p-8">
            <div id="idCard" class="bg-emerald-800 p-6 rounded-2xl text-white text-center w-64">
                <img id="printFoto" class="w-20 h-20 rounded-full mx-auto mb-4 border-2 border-white/20 object-cover">
                <h2 id="printNama" class="font-bold uppercase"></h2>
                <p id="printJabatan" class="text-[10px] opacity-70"></p>
                <div id="qrcode" class="my-4 flex justify-center bg-white p-2 rounded-lg"></div>
                <p id="printNip" class="text-[10px] opacity-50"></p>
            </div>
            <button onclick="window.print()" class="btn-primary w-full mt-4 py-2">CETAK</button>
            <button onclick="document.getElementById('idCardModal').classList.replace('flex','hidden')" class="w-full mt-2 text-white/50 text-xs">Tutup</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vxcgontdprrnotipdstx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Y2dvbnRkcHJybm90aXBkc3R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDU3NzUsImV4cCI6MjA4NTc4MTc3NX0.LgMMA5ysutL4sgHCDWZea20gvv9hwRQHPAX2BougW1U';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let dbPegawai = [];

        // Logika Load Data Persis Simpeg.txt
        async function loadData() {
            const { data, error } = await _supabase.from('pegawai').select('*').order('created_at', { ascending: false });
            if (error) { console.error(error); return; }
            dbPegawai = data;
            renderTable();
        }

        function renderTable() {
            const body = document.getElementById('pegawaiTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const hariIni = new Date();
            
            body.innerHTML = '';
            dbPegawai.filter(p => p.nama.toLowerCase().includes(search) || (p.nip && p.nip.includes(search))).forEach(p => {
                let sipAlert = '';
                if(p.sipDeadline) {
                    let d = new Date(p.sipDeadline);
                    let diff = Math.ceil((d - hariIni) / (1000 * 60 * 60 * 24 * 30.44));
                    if(diff <= 6) sipAlert = `<span class="text-rose-500 font-bold text-[10px]">[SIP ${diff} BLN]</span>`;
                }

                body.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>
                            <div class="flex items-center gap-3">
                                <img src="${p.foto || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover">
                                <div><b class="text-white">${p.nama}</b><br><small class="text-slate-500">${p.jabatan} | NIP: ${p.nip || '-'}</small></div>
                            </div>
                        </td>
                        <td>${sipAlert || '<span class="text-emerald-500 text-[10px]">âœ” AMAN</span>'}</td>
                        <td class="text-center">
                            <button onclick="bukaCetak('${p.id}')" class="text-emerald-500 mr-3"><i class="fas fa-id-card"></i></button>
                            <button onclick="hapusData('${p.id}', '${p.nama}')" class="text-slate-500"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }

        // Simpan Data Asli
        document.getElementById('pegawaiForm').onsubmit = async (e) => {
            e.preventDefault();
            const file = document.getElementById('fotoPegawai').files[0];
            let fotoUrl = "";

            if(file) {
                const fileName = `${Date.now()}-${file.name}`;
                const { data, error } = await _supabase.storage.from('avatars').upload(fileName, file);
                if(data) {
                    const { data: pub } = _supabase.storage.from('avatars').getPublicUrl(fileName);
                    fotoUrl = pub.publicUrl;
                }
            }

            const { error } = await _supabase.from('pegawai').insert([{
                nama: document.getElementById('namaPegawai').value,
                nip: document.getElementById('nipPegawai').value,
                wa: document.getElementById('waPegawai').value,
                jabatan: document.getElementById('jabatanPegawai').value,
                tglLahir: document.getElementById('tglLahir').value,
                sipDeadline: document.getElementById('sipDeadline').value,
                foto: fotoUrl
            }]);

            if(!error) { loadData(); e.target.reset(); }
            else { alert("Gagal menyimpan!"); }
        };

        async function hapusData(id, nama) {
            if(confirm(`Hapus ${nama}?`)) {
                await _supabase.from('pegawai').delete().eq('id', id);
                loadData();
            }
        }

        function bukaCetak(id) {
            const p = dbPegawai.find(x => x.id == id);
            document.getElementById('printNama').innerText = p.nama;
            document.getElementById('printJabatan').innerText = p.jabatan;
            document.getElementById('printNip').innerText = `NIP. ${p.nip || '-'}`;
            document.getElementById('printFoto').src = p.foto || 'https://via.placeholder.com/150';
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: `VERIFIED-${p.nip}`, width: 60, height: 60 });
            document.getElementById('idCardModal').classList.replace('hidden', 'flex');
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID'); }, 1000);
        loadData();
    </script>
</body>
</html>
