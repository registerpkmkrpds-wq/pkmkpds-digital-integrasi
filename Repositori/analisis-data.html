<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Data | PKM Kiarapedes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: #f1f5f9; overflow-x: hidden; }
        
        .hero-gradient {
            background: radial-gradient(circle at top right, rgba(16, 185, 129, 0.1), transparent),
                        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.1), transparent);
            min-height: 100vh;
        }

        .glass-panel { 
            background: rgba(30, 41, 59, 0.5); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            border-radius: 2rem; 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(16, 185, 129, 0.2); border-radius: 10px; }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="hero-gradient p-4 md:p-8">

    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-slate-950 flex items-center justify-center p-6">
        <div class="glass-panel p-10 w-full max-w-md text-center border-emerald-500/20">
            <div class="w-20 h-20 bg-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl">
                <i class="fas fa-chart-line text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 uppercase tracking-tighter text-white">Gateway <span class="text-emerald-500">ANALYTICS</span></h2>
            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] mb-8">PWS Strategic Engine</p>
            <form id="loginForm" class="space-y-4 text-left">
                <input type="text" id="userInput" placeholder="Username" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-emerald-500 transition" required>
                <input type="password" id="passInput" placeholder="Password" class="w-full bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:border-emerald-500 transition" required>
                <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase text-xs hover:bg-emerald-500 transition-all mt-4">Buka Dashboard</button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="max-w-7xl mx-auto hidden">
        
        <header class="flex justify-between items-center mb-10 no-print">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-microchip text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tighter text-white uppercase">Smart Dashboard <span class="text-emerald-500">PWS</span></h1>
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.3em]">Reconciliation & Strategy Engine</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="exportLaporanPDF()" class="bg-rose-600/20 text-rose-500 border border-rose-500/30 px-5 py-3 rounded-xl font-black text-[10px] uppercase flex items-center gap-2 hover:bg-rose-600 hover:text-white transition">
                    <i class="fas fa-file-pdf"></i> Cetak PDF
                </button>
                <button onclick="logout()" class="bg-white/5 text-slate-400 p-4 rounded-xl hover:bg-rose-500 hover:text-white transition">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10 no-print">
            <div onclick="document.getElementById('fileAsik').click()" class="glass-panel p-8 border-2 border-dashed border-emerald-500/20 hover:border-emerald-500/50 hover:bg-emerald-500/5 cursor-pointer transition-all group text-center">
                <input type="file" id="fileAsik" class="hidden" accept=".xlsx, .xls" onchange="handleFileUpload(this, 'asik')">
                <i class="fas fa-cloud-arrow-up text-emerald-500 text-3xl mb-4 group-hover:scale-110 transition"></i>
                <h4 class="text-[10px] font-black uppercase tracking-widest text-white">Import Data ASIK</h4>
                <p class="text-[8px] text-slate-500 mt-1 italic">Drag & drop or click to upload .xlsx</p>
            </div>
            <div onclick="document.getElementById('fileEpus').click()" class="glass-panel p-8 border-2 border-dashed border-emerald-500/20 hover:border-emerald-500/50 hover:bg-emerald-500/5 cursor-pointer transition-all group text-center">
                <input type="file" id="fileEpus" class="hidden" accept=".xlsx, .xls" onchange="handleFileUpload(this, 'epus')">
                <i class="fas fa-hospital-user text-emerald-500 text-3xl mb-4 group-hover:scale-110 transition"></i>
                <h4 class="text-[10px] font-black uppercase tracking-widest text-white">Import e-Puskesmas</h4>
                <p class="text-[8px] text-slate-500 mt-1 italic">Data real-time dari aplikasi klinis</p>
            </div>
        </div>

        <div id="printArea">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-panel p-6 border-b-4 border-blue-500">
                    <p class="text-[9px] font-black opacity-50 uppercase mb-1">Capaian ASIK</p>
                    <h2 id="statAsik" class="text-3xl font-black text-blue-500">0</h2>
                </div>
                <div class="glass-panel p-6 border-b-4 border-emerald-500">
                    <p class="text-[9px] font-black opacity-50 uppercase mb-1">Capaian e-PKM</p>
                    <h2 id="statEpus" class="text-3xl font-black text-emerald-500">0</h2>
                </div>
                <div class="glass-panel p-6 border-b-4 border-amber-500">
                    <p class="text-[9px] font-black opacity-50 uppercase mb-1">Selisih Data</p>
                    <h2 id="totalPending" class="text-3xl font-black text-amber-500">0</h2>
                </div>
                <div class="glass-panel p-6 border-b-4 border-rose-500">
                    <p class="text-[9px] font-black opacity-50 uppercase mb-1">Realisasi Anggaran</p>
                    <h2 id="statBudget" class="text-lg font-black text-rose-500">Rp 0</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="lg:col-span-2 glass-panel p-8">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-widest">Visualisasi Sinkronisasi Desa</h3>
                    <div class="h-80"><canvas id="chartComparison"></canvas></div>
                </div>
                <div class="glass-panel p-8">
                    <h3 class="text-[10px] font-black text-emerald-500 uppercase mb-6 tracking-widest">Top 5 Penyakit (ICD-10)</h3>
                    <div id="icdList" class="space-y-4">
                        <p class="text-slate-600 text-[10px] italic">Upload data e-Puskesmas untuk melihat analisis.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-20">
                <div class="glass-panel p-8 border-l-8 border-emerald-500 bg-emerald-500/5">
                    <h3 class="text-[10px] font-black text-emerald-500 uppercase mb-6 flex items-center gap-2">
                        <i class="fas fa-brain"></i> AI Strategic Evaluation (RTL)
                    </h3>
                    <div id="aiEvaluation" class="text-[11px] leading-relaxed text-slate-300">
                        <p class="italic text-slate-500">Sistem menunggu data input untuk merumuskan rekomendasi strategi...</p>
                    </div>
                </div>
                <div class="glass-panel p-8">
                    <h3 class="text-[10px] font-black text-amber-500 uppercase mb-6 flex items-center gap-2">
                        <i class="fas fa-triangle-exclamation"></i> Discrepancy Alerts
                    </h3>
                    <div id="validationLog" class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                        <p class="text-[10px] text-slate-600 italic text-center py-10">Tidak ada selisih data yang ditemukan.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[1000] no-print">
        <div class="bg-slate-900/80 backdrop-blur-xl border border-white/10 px-8 py-4 rounded-[2rem] flex items-center gap-10 shadow-2xl">
            <a href="index.html" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-home text-slate-500 group-hover:text-emerald-500 transition-all"></i>
                <span class="text-[7px] font-black uppercase text-slate-500">Portal</span>
            </a>
            <a href="e-arsip.html" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-box-archive text-slate-500 group-hover:text-emerald-500 transition-all"></i>
                <span class="text-[7px] font-black uppercase text-slate-500">Arsip</span>
            </a>
            <a href="simpeg.html" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-user-tie text-slate-500 group-hover:text-emerald-500 transition-all"></i>
                <span class="text-[7px] font-black uppercase text-slate-500">Simpeg</span>
            </a>
            <div class="flex flex-col items-center gap-1">
                <div class="w-1 h-1 bg-emerald-500 rounded-full mb-1"></div>
                <i class="fas fa-chart-pie text-emerald-500"></i>
                <span class="text-[7px] font-black uppercase text-emerald-500">Analisis</span>
            </div>
        </div>
    </div>

    <script>
        const WILAYAH = ["KIARAPEDES", "GAROKGEK", "CIBEBER", "MARGALUYU", "CIRACAS", "PARAKAN GAROKGEK"];
        const KONTAK = { "KIARAPEDES": "628xxx", "GAROKGEK": "628xxx", "CIBEBER": "628xxx", "MARGALUYU": "628xxx", "CIRACAS": "628xxx", "PARAKAN GAROKGEK": "628xxx" };
        const BUDGET = { total: 500000000, realisasi: 325000000 };
        let DATA_ASIK = {}, DATA_EPUS = {}, chartObj = null;

        // AUTH & SSO
        window.onload = function() {
            if (localStorage.getItem('pkm_isLoggedIn') === 'true') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initDashboard();
            }
        };

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const user = document.getElementById('userInput').value;
            const pass = document.getElementById('passInput').value;
            if(user === 'admin' && pass === 'pkp123') {
                localStorage.setItem('pkm_isLoggedIn', 'true');
                location.reload();
            } else { alert("Akses Ditolak!"); }
        };

        function logout() { if(confirm("Keluar sistem?")) { localStorage.clear(); location.reload(); } }

        function initDashboard() {
            document.getElementById('statBudget').innerText = "Rp " + BUDGET.realisasi.toLocaleString('id-ID');
        }

        function handleFileUpload(input, type) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const result = { total: 0, desa: {}, icd: {} };
                WILAYAH.forEach(w => result.desa[w] = 0);

                json.forEach(row => {
                    const rowText = Object.values(row).join(" ").toUpperCase();
                    const count = parseInt(row['Jumlah'] || row['Capaian'] || 1);
                    WILAYAH.forEach(w => { if(rowText.includes(w)) result.desa[w] += count; });
                    const diag = row['Diagnosis'] || row['Nama Penyakit'];
                    if(diag && type === 'epus') result.icd[diag] = (result.icd[diag] || 0) + 1;
                    result.total += count;
                });

                if(type === 'asik') { DATA_ASIK = result; }
                else { DATA_EPUS = result; }
                
                renderAnalysis(DATA_EPUS.icd);
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function renderAnalysis(icdData) {
            const ctx = document.getElementById('chartComparison').getContext('2d');
            const log = document.getElementById('validationLog');
            log.innerHTML = "";
            let pending = 0;

            const dAsik = WILAYAH.map(w => DATA_ASIK.desa ? DATA_ASIK.desa[w] : 0);
            const dEpus = WILAYAH.map(w => DATA_EPUS.desa ? DATA_EPUS.desa[w] : 0);

            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: WILAYAH,
                    datasets: [
                        { label: 'ASIK', data: dAsik, backgroundColor: '#3b82f6', borderRadius: 8 },
                        { label: 'e-PKM', data: dEpus, backgroundColor: '#10b981', borderRadius: 8 }
                    ]
                },
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#94a3b8', font: { size: 10, weight: 'bold' } } } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                        x: { grid: { display: false }, ticks: { color: '#64748b' } }
                    }
                }
            });

            WILAYAH.forEach((desa, i) => {
                const diff = dEpus[i] - dAsik[i];
                if(diff > 0) {
                    pending += diff;
                    log.insertAdjacentHTML('beforeend', `
                        <div class="p-4 rounded-2xl bg-amber-500/10 border border-amber-500/20 flex justify-between items-center group hover:bg-amber-500/20 transition">
                            <div><p class="text-[10px] font-black uppercase text-white">${desa}</p><p class="text-[9px] text-amber-500 font-bold">Selisih: ${diff} data</p></div>
                            <button onclick="kirimWA('${desa}', ${diff})" class="bg-emerald-600 px-3 py-1.5 rounded-lg text-[8px] font-black uppercase text-white shadow-lg">WA Tagih</button>
                        </div>
                    `);
                }
            });

            if(icdData) {
                const top5 = Object.entries(icdData).sort((a,b)=>b[1]-a[1]).slice(0,5);
                document.getElementById('icdList').innerHTML = top5.map(([n,v]) => `
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span class="text-[9px] font-bold uppercase text-slate-400 max-w-[150px] truncate">${n}</span>
                        <span class="text-blue-500 font-black text-xs">${v}</span>
                    </div>
                `).join('');
                
                const topDiag = top5[0] ? top5[0][0] : "N/A";
                const budRemaining = BUDGET.total - BUDGET.realisasi;
                document.getElementById('aiEvaluation').innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="w-2 h-2 rounded-full bg-emerald-500 mt-1"></div>
                            <p>Ditemukan <b class="text-white text-xs">${pending} data</b> e-PKM yang belum ter-sinkron ke ASIK. Prioritaskan desa dengan selisih > 10 data.</p>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="w-2 h-2 rounded-full bg-blue-500 mt-1"></div>
                            <p>Penyakit <b class="text-white text-xs">${topDiag}</b> mendominasi kunjungan. Perlu evaluasi stok obat terkait.</p>
                        </div>
                        <div class="p-4 bg-emerald-500/10 rounded-2xl border border-emerald-500/20">
                            <p class="font-black text-emerald-500 mb-2 uppercase text-[9px] tracking-widest">Rencana Tindak Lanjut (RTL):</p>
                            <ul class="list-disc ml-4 space-y-2 opacity-80 text-[10px]">
                                <li>Instruksikan PJ Desa untuk rekonsiliasi data maksimal H+2.</li>
                                <li>Gunakan sisa budget Rp ${budRemaining.toLocaleString()} untuk intervensi spesifik ${topDiag}.</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            document.getElementById('statAsik').innerText = DATA_ASIK.total || 0;
            document.getElementById('statEpus').innerText = DATA_EPUS.total || 0;
            document.getElementById('totalPending').innerText = pending;
        }

        function kirimWA(desa, selisih) {
            const pesan = `Halo Rekan *Desa ${desa}*, hasil audit sistem menunjukkan ada *${selisih} data* e-PKM yang belum terinput ke ASIK. Mohon segera divalidasi. Terima kasih.`;
            window.open(`https://wa.me/${KONTAK[desa]}?text=${encodeURIComponent(pesan)}`, '_blank');
        }

        function exportLaporanPDF() {
            const el = document.getElementById('printArea');
            const opt = {
                margin: 10,
                filename: 'Laporan_PWS_Kiarapedes.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#0f172a' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(el).save();
        }
    </script>
</body>
</html>
