<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Analis Kesehatan Pro - Custom Command Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Arial, sans-serif; }
        #pdf-content { background: white; width: 210mm; min-height: 297mm; padding: 20mm; margin: 20px auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); font-size: 11pt; color: #333; }
        .table-laporan { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10pt; }
        .table-laporan th, .table-laporan td { border: 1px solid #000; padding: 8px; text-align: center; }
        .table-laporan th { background-color: #f2f2f2; }
        .section-title { border-bottom: 2px solid #1b5e20; color: #1b5e20; font-weight: bold; margin-top: 20px; text-transform: uppercase; }
        .recommendation-box { background-color: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; margin-top: 15px; border-left: 5px solid #2e7d32; }
        .control-panel { max-width: 950px; margin: 20px auto; }
        .chart-container { height: 280px; margin: 20px 0; }
        .custom-cmd { background-color: #fff9c4; border: 1px solid #fbc02d; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="container no-print control-panel">
    <div class="card p-4 shadow-sm border-0">
        <h5 class="fw-bold text-success mb-3">Panel Kendali Analis AI Gemini</h5>
        
        <div class="row">
            <div class="col-md-6">
                <label class="fw-bold small">1. Tempel Data Excel / Narasi:</label>
                <textarea id="rawInput" class="form-control mb-3" rows="8" placeholder="Contoh: Salin tabel dari Excel di sini..."></textarea>
            </div>
            
            <div class="col-md-6">
                <label class="fw-bold small">2. Instruksi Khusus (Perintah Anda):</label>
                <textarea id="customCommand" class="form-control custom-cmd mb-3" rows="8" placeholder="Contoh: 'Buat rekomendasi yang fokus pada peran bidan desa' atau 'Gunakan bahasa yang sangat formal untuk Kepala Dinas'"></textarea>
            </div>
        </div>

        <div class="row g-2">
            <div class="col-md-5">
                <input type="password" id="apiKey" class="form-control" placeholder="Masukkan Gemini API Key">
            </div>
            <div class="col-md-4">
                <button onclick="analisisGemini()" class="btn btn-success w-100 fw-bold">PROSES ANALISA & PERINTAH âœ¨</button>
            </div>
            <div class="col-md-3">
                <button onclick="downloadPDF()" class="btn btn-dark w-100">SIMPAN PDF ðŸ“„</button>
            </div>
        </div>
        <small class="text-muted mt-2 d-block text-center">API Key tersimpan otomatis di browser Anda.</small>
    </div>
</div>

<div id="pdf-content">
    <div class="text-center mb-4">
        <h4 class="fw-bold mb-1">LAPORAN ANALISIS & CAPAIAN KESEHATAN</h4>
        <p class="text-muted small" id="tglLaporan"></p>
    </div>

    <div id="outputArea">
        <p class="text-center text-muted mt-5">Data tabel, grafik, dan analisis akan muncul di sini setelah diproses.</p>
    </div>

    <div id="chartArea" style="display:none;">
        <div class="section-title">Visualisasi Capaian Program</div>
        <div class="chart-container"><canvas id="autoChart"></canvas></div>
    </div>
</div>

<script>
    let myChart = null;

    async function analisisGemini() {
        const text = document.getElementById('rawInput').value;
        const command = document.getElementById('customCommand').value;
        const key = document.getElementById('apiKey').value;
        
        if(!key) return alert("Harap masukkan API Key Gemini!");
        localStorage.setItem('gemini_key', key);

        document.getElementById('outputArea').innerHTML = "<div class='text-center py-5'><div class='spinner-border text-success'></div><p class='mt-2'>AI sedang menjalankan perintah Anda...</p></div>";

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

        // Menggabungkan Perintah Sistem dengan Instruksi User
        const prompt = `Bertindaklah sebagai analis kesehatan profesional. 
        Tugas utama:
        1. Jika input berupa data tab-separated/Excel, buat tabel HTML class='table-laporan'.
        2. Buat ringkasan narasi yang rapi.
        3. Ekstrak data angka untuk grafik batang.
        4. Berikan analisa masalah dan rekomendasi perbaikan.
        
        INSTRUKSI TAMBAHAN DARI USER: "${command || 'Berikan analisis standar yang profesional'}"

        Output WAJIB JSON murni tanpa markdown: 
        { "ringkasan": "string", "tabel_html": "string", "data_grafik": {"labels":[], "values":[]}, "analisa": "string", "rekomendasi": ["string"] }
        
        Data Input: ${text}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const resData = await response.json();
            const rawResponse = resData.candidates[0].content.parts[0].text;
            const cleanJson = rawResponse.replace(/```json|```/g, "").trim();
            const data = JSON.parse(cleanJson);
            renderLaporan(data);
        } catch (e) {
            alert("Gagal memproses. Pastikan API Key benar dan internet stabil.");
            console.error(e);
        }
    }

    function renderLaporan(data) {
        document.getElementById('outputArea').innerHTML = `
            <div class="section-title">I. Ringkasan Laporan</div>
            <p class="mt-2 text-justify">${data.ringkasan}</p>
            
            <div class="section-title">II. Tabel Data</div>
            <div class="table-responsive">${data.tabel_html}</div>

            <div class="section-title">III. Analisa & Masalah</div>
            <p class="mt-2">${data.analisa}</p>

            <div class="recommendation-box">
                <h6 class="fw-bold">IV. REKOMENDASI & TINDAK LANJUT</h6>
                <ul class="mb-0">${data.rekomendasi.map(item => `<li>${item}</li>`).join('')}</ul>
            </div>
        `;
        document.getElementById('chartArea').style.display = 'block';
        updateChart(data.data_grafik.labels, data.data_grafik.values);
    }

    function updateChart(labels, values) {
        const ctx = document.getElementById('autoChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Capaian (%)', data: values, backgroundColor: '#1b5e20', borderRadius: 5 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        html2pdf().from(element).set({
            margin: 10, filename: 'Laporan_Puskesmas_AI.pdf',
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }

    window.onload = () => {
        document.getElementById('tglLaporan').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const savedKey = localStorage.getItem('gemini_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;
    };
</script>
</body>
</html>
