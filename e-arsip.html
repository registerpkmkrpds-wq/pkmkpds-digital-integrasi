<!DOCTYPE html>
<html lang="id">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>E-Arsip Pro | PKM Kiarapedes</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   
    <style>
       @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
       body { font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.3s ease; }
       
       /* Dark Mode Theme */
       .dark-theme { background-color: #0f172a; color: #f1f5f9; }
       .dark-theme .card { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
       .dark-theme .input-field { background-color: #334155; border-color: #475569; color: white; }
       .dark-theme .bg-white { background-color: #1e293b; }
       .dark-theme .bg-slate-50 { background-color: #0f172a; }
       .dark-theme .text-slate-800, .dark-theme .text-slate-700 { color: #f1f5f9; }
       .dark-theme .divide-slate-100 > :not([hidden]) ~ :not([hidden]) { border-color: #334155; }

       .header-gradient { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
       .hidden { display: none !important; }
       .card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
       .input-field { width: 100%; padding: 0.75rem 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; outline: none; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; }
       .input-field:focus { border-color: #059669; border-width: 2px; background: white; }
       .glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

<div id="loading" class="hidden fixed inset-0 z-[9999] bg-emerald-600/90 backdrop-blur-sm flex flex-col items-center justify-center text-white">
   <div class="w-10 h-10 border-4 border-white/30 border-t-white rounded-full animate-spin mb-4"></div>
   <p class="font-bold text-xs tracking-widest uppercase">Sinkronisasi Data...</p>
</div>

<div id="loginPage" class="fixed inset-0 z-[999] bg-slate-900 flex items-center justify-center p-4">
   <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
       <div class="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6">
           <i class="fas fa-hospital text-3xl"></i>
       </div>
       <h2 class="text-2xl font-black text-slate-800 mb-2 uppercase text-emerald-600">Login | E-Arsip</h2>
       <p class="text-slate-400 text-[10px] mb-8 font-bold uppercase tracking-widest leading-none">Puskesmas Kiarapedes</p>
       <div class="space-y-4">
           <input type="text" id="userInput" placeholder="Username" class="input-field text-center" onkeypress="handleEnter(event)">
           <input type="password" id="passInput" placeholder="Password" class="input-field text-center" onkeypress="handleEnter(event)">
           <button onclick="handleLogin()" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold uppercase shadow-lg hover:scale-[1.02] transition-all">Masuk</button>
       </div>
   </div>
</div>

<div id="mainApp" class="hidden">
   <header class="header-gradient text-white pt-6 pb-24 shadow-lg">
       <nav class="container mx-auto px-6 flex justify-between items-center mb-8">
           <div class="flex items-center gap-4">
               <div class="bg-white/20 w-12 h-12 rounded-2xl flex items-center justify-center backdrop-blur-md border border-white/30 text-2xl">
                   <i class="fas fa-file-shield"></i>
               </div>
               <div>
                   <h1 class="font-black text-xl uppercase leading-none">Arsip Digital</h1>
                   <p id="userLabel" class="text-[10px] font-bold uppercase tracking-widest opacity-80 mt-1"></p>
               </div>
           </div>
           <div class="flex gap-2">
                <button onclick="toggleDarkMode()" class="p-3 glass rounded-xl hover:bg-white/20 transition">
                    <i id="darkIcon" class="fas fa-moon"></i>
               </button>
               <button onclick="exportToPDF()" class="bg-white/20 hover:bg-white/40 px-4 py-2 rounded-xl font-bold text-[10px] uppercase border border-white/20 transition">Export PDF</button>
               <button onclick="location.reload()" class="bg-rose-500 hover:bg-rose-600 w-10 h-10 flex items-center justify-center rounded-xl transition shadow-lg"><i class="fas fa-power-off"></i></button>
           </div>
       </nav>
       <div class="container mx-auto px-6">
           <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
       </div>
   </header>

   <main class="container mx-auto px-6 -mt-12 pb-12">
       
       <div class="card p-6 mb-8 shadow-xl bg-white no-print">
            <h3 class="text-[10px] font-black text-slate-400 mb-4 uppercase tracking-[0.2em] flex items-center gap-2">
                <i class="fas fa-chart-line text-emerald-500"></i> Statistik Aktivitas Bulanan
            </h3>
            <div class="h-[250px] w-full">
                <canvas id="arsipChart"></canvas>
            </div>
       </div>

       <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
           <div id="adminPanel" class="lg:col-span-4 space-y-6">
               <div class="card p-8 shadow-xl">
                   <h3 class="text-[10px] font-black text-emerald-600 mb-6 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-plus-circle"></i> Registrasi Arsip</h3>
                   <form id="docForm" class="space-y-4">
    <div class="grid grid-cols-2 gap-2">
        <select id="docGroup" class="input-field">
            <option value="A">GRUP A</option>
            <option value="B">GRUP B</option>
            <option value="C">GRUP C</option>
            <option value="D">GRUP D</option>
            <option value="E">GRUP E</option>
            <option value="F">GRUP F</option>
        </select>
        <select id="docCatType" class="input-field">
            <option value="BA">Berita Acara (BA)</option>
            <option value="SK">Surat Keputusan (SK)</option>
            <option value="SOP">Prosedur (SOP)</option>
            <option value="ST">Surat Tugas(ST)</option>
            <option value="SKT">Surat Keterangan (SKT)</option>
            <option value="SL">Surat Lainnya (SL)</option>
            <option value="UND">Undangan (UND)</option>
            <option value="DB">Dokumen Bukti (DB)</option>
            <option value="DU">Dokumen Umum (DU)</option>
            <option value="Vid">Video (Vid)</option>
        </select>
    </div>
    
    <select id="docStatus" class="input-field">
        <option value="Selesai">‚úÖ Selesai</option>
        <option value="Proses">‚è≥ Proses</option>
        <option value="Penting">üö® Penting</option>
    </select>
    
    <input type="text" id="docName" placeholder="Perihal/Nama Dokumen" class="input-field" required>
    
    <div class="relative group">
        <label class="block text-[10px] font-black text-emerald-600 mb-2 uppercase ml-1">Upload File (PDF/Gambar)</label>
        <input type="file" id="fileInput" class="hidden" onchange="updateFileName()">
        <button type="button" onclick="document.getElementById('fileInput').click()" 
                class="w-full py-3 px-4 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl text-slate-500 text-xs font-bold hover:border-emerald-500 hover:text-emerald-600 transition-all">
            <i class="fas fa-cloud-upload-alt mr-2 text-emerald-500"></i> <span id="fileNameDisplay">Pilih Dokumen...</span>
        </button>
    </div>

    <input type="url" id="docLink" placeholder="Atau Link Google Drive" class="input-field">
    
    <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-emerald-700 transition-all">
        Simpan 
</button>
</form>
                       <input type="text" id="docName" placeholder="Perihal/Nama Dokumen" class="input-field" required>
                       <input type="url" id="docLink" placeholder="Link Google Drive" class="input-field">
                       <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-emerald-700 transition-all">Simpan Data</button>
                   </form>
               </div>
               <div class="grid grid-cols-2 gap-3">
                   <button onclick="openModal('agendaModal')" class="bg-blue-600 text-white p-4 rounded-2xl font-bold text-[10px] uppercase shadow-lg flex flex-col items-center gap-2 hover:bg-blue-700 transition"><i class="fas fa-inbox text-xl"></i> Surat Masuk</button>
                   <button onclick="openModal('suratKeluarModal')" class="bg-rose-600 text-white p-4 rounded-2xl font-bold text-[10px] uppercase shadow-lg flex flex-col items-center gap-2 hover:bg-rose-700 transition"><i class="fas fa-paper-plane text-xl"></i> Surat Keluar</button>
               </div>
           </div>

           <div id="tableContainer" class="lg:col-span-8 space-y-6">
               <div class="card p-4 flex flex-wrap gap-4 items-center bg-white shadow-lg">
                   <div class="flex-1 relative min-w-[200px]">
                       <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                       <input type="text" id="search" oninput="renderTable()" placeholder="Cari nomor atau perihal..." class="w-full pl-12 pr-6 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-sm">
                   </div>
               </div>

               <div class="card overflow-hidden shadow-xl bg-white">
                   <div class="overflow-x-auto">
                       <table class="w-full text-left border-collapse">
                           <thead class="bg-slate-50 border-b border-slate-100 text-[10px] text-slate-400 font-black uppercase tracking-widest">
                               <tr>
                                   <th class="px-6 py-5">No. Arsip</th>
                                   <th class="px-6 py-5">Detail Dokumen</th>
                                   <th class="px-6 py-5 text-center">Status</th>
                                   <th class="px-6 py-5 text-center">Aksi</th>
                               </tr>
                           </thead>
                           <tbody id="tableBody" class="divide-y divide-slate-100 text-sm font-semibold"></tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>
   </main>
</div>

<div id="qrModal" class="fixed inset-0 z-[110] bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
   <div class="bg-white p-8 rounded-[2.5rem] text-center max-w-xs w-full shadow-2xl">
       <div id="qrcode" class="flex justify-center mb-6 p-4 bg-white border-4 border-slate-50 rounded-2xl"></div>
       <p id="qrTitle" class="text-xs font-bold text-slate-800 uppercase mb-6 leading-tight"></p>
       <button onclick="closeModal('qrModal')" class="w-full bg-slate-100 text-slate-600 py-3 rounded-xl font-black text-[10px] uppercase">Tutup</button>
   </div>
</div>

<div id="agendaModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
   <div class="bg-white w-full max-w-md rounded-[2rem] p-8">
       <h2 class="font-black text-xs uppercase mb-6 flex items-center gap-2"><i class="fas fa-inbox text-blue-500"></i> Surat Masuk</h2>
       <div class="space-y-3">
           <input type="text" id="agAsal" placeholder="Asal Surat" class="input-field">
           <input type="text" id="agPerihal" placeholder="Perihal" class="input-field">
           <input type="url" id="agLink" placeholder="Link Drive" class="input-field">
           <div class="flex gap-3 pt-4"><button onclick="closeModal('agendaModal')" class="flex-1 py-3 text-[10px] font-bold uppercase text-slate-400">Batal</button><button onclick="saveAgenda()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-[10px] uppercase">Simpan</button></div>
       </div>
   </div>
</div>

<div id="suratKeluarModal" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md hidden flex items-center justify-center p-4">
   <div class="bg-white w-full max-w-md rounded-[2rem] p-8">
       <h2 class="font-black text-xs uppercase mb-6 flex items-center gap-2"><i class="fas fa-paper-plane text-rose-500"></i> Surat Keluar</h2>
       <div class="space-y-3">
           <select id="skKode" class="input-field"><option value="ST">ST</option><option value="SK">SK</option><option value="UND">UND</option><option value="BA">BA</option><option value="SRT">SRT</option></select>
           <input type="text" id="skTujuan" placeholder="Tujuan" class="input-field">
           <input type="text" id="skPerihal" placeholder="Perihal" class="input-field">
           <div class="flex gap-3 pt-4"><button onclick="closeModal('suratKeluarModal')" class="flex-1 py-3 text-[10px] font-bold uppercase text-slate-400">Batal</button><button onclick="saveSuratKeluar()" class="flex-1 py-3 bg-rose-600 text-white rounded-xl font-bold text-[10px] uppercase">Simpan</button></div>
       </div>
   </div>
</div>

<script>
function updateFileName() {
    const file = document.getElementById('fileInput').files[0];
    const display = document.getElementById('fileNameDisplay');
    if (file) {
        display.innerText = file.name;
        display.classList.add('text-emerald-600');
    } else {
        display.innerText = "Pilih Dokumen...";
        display.classList.remove('text-emerald-600');
    }
}
   const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyJQo3viQyNmdgOQYS8amOBMrGHjaiZ14v0olGYZx66CB7OKq7ZVSmUZnn5dvsIr9wKGg/exec"; 
   const CONFIG = { instansi: "PKM-KRPDS", tahun: "2026" };
   let db = [];
   let role = 'viewer';
   let myChart = null;

   // 1. FUNGSI DARK MODE
   function toggleDarkMode() {
       const isDark = document.body.classList.toggle('dark-theme');
       document.getElementById('darkIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
       localStorage.setItem('themeArsip', isDark ? 'dark' : 'light');
       renderChart(); // Redraw chart for color sync
   }
   if(localStorage.getItem('themeArsip') === 'dark') toggleDarkMode();

   function showLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }
   function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
   function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

   function handleEnter(event) { if (event.key === "Enter") { handleLogin(); } }

   function handleLogin() {
       const u = document.getElementById('userInput').value;
       const p = document.getElementById('passInput').value;
       if(u === 'admin' && p === 'pkp') { role = 'admin'; }
       else if(u === 'viewer' && p === 'baca') { role = 'viewer'; }
       else { alert("Username atau Password Salah!"); return; }
       
       document.getElementById('loginPage').classList.add('hidden');
       document.getElementById('mainApp').classList.remove('hidden');
       document.getElementById('userLabel').innerText = `Role: ${role.toUpperCase()}`;
       if(role === 'viewer') {
           document.getElementById('adminPanel').classList.add('hidden');
           document.getElementById('tableContainer').classList.replace('lg:col-span-8', 'lg:col-span-12');
       }
       loadFromCloud();
   }

   async function loadFromCloud() {
       showLoading(true);
       try { const res = await fetch(WEB_APP_URL); db = await res.json(); renderTable(); } catch (e) { console.error(e); }
       showLoading(false);
   }

   async function syncToCloud() {
       showLoading(true);
       try { await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "saveAll", db: db }) }); updateStats(); renderChart(); } catch (e) { console.error(e); }
       setTimeout(() => showLoading(false), 800);
   }

   // 2. FUNGSI GRAFIK
   function renderChart() {
       const ctx = document.getElementById('arsipChart').getContext('2d');
       const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];
       let monthlyCounts = new Array(12).fill(0);

       db.forEach(item => {
           const dateParts = item.t.split('/');
           if (dateParts.length === 3) {
               const mIndex = parseInt(dateParts[1]) - 1;
               if(mIndex >= 0 && mIndex < 12) monthlyCounts[mIndex]++;
           }
       });

       const isDark = document.body.classList.contains('dark-theme');

       if(myChart) myChart.destroy();
       myChart = new Chart(ctx, {
           type: 'line',
           data: {
               labels: months,
               datasets: [{
                   label: 'Jumlah Dokumen',
                   data: monthlyCounts,
                   borderColor: '#10b981',
                   backgroundColor: 'rgba(16, 185, 129, 0.1)',
                   borderWidth: 4,
                   tension: 0.4,
                   fill: true,
                   pointBackgroundColor: '#fff'
               }]
           },
           options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: { legend: { display: false } },
               scales: {
                   y: { 
                       beginAtZero: true, 
                       grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                       ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                    },
                   x: { 
                       grid: { display: false },
                       ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                    }
               }
           }
       });
   }

   function renderTable() {
       const body = document.getElementById('tableBody');
       const s = document.getElementById('search').value.toLowerCase();
       body.innerHTML = db.filter(i => i.n.toLowerCase().includes(s) || i.formatNo.toLowerCase().includes(s)).map(i => {
           const hasL = i.l && i.l.trim() !== "";
           const stColor = i.status === 'Selesai' ? 'bg-blue-50 text-blue-600' : i.status === 'Penting' ? 'bg-rose-50 text-rose-600' : 'bg-amber-50 text-amber-600';
           return `
           <tr class="hover:bg-slate-50 transition-all border-l-4 ${i.k === 'A' ? 'border-blue-500' : 'border-emerald-500'}">
               <td class="px-6 py-5"><span class="text-[9px] font-black bg-slate-100 px-3 py-1 rounded-lg text-slate-600">${i.formatNo}</span></td>
               <td class="px-6 py-5"><div class="font-bold text-slate-800 text-[11px] uppercase truncate max-w-xs">${i.n}</div><div class="text-[9px] text-slate-400 mt-1 uppercase font-bold">${i.t} | KAT: ${i.k}</div></td>
               <td class="px-6 py-5 text-center"><span class="text-[8px] font-black px-3 py-1 rounded-full uppercase ${stColor}">${(i.status || 'Selesai').toUpperCase()}</span></td>
               <td class="px-6 py-5"><div class="flex justify-center gap-1.5">
                   ${hasL ? `<a href="${i.l}" target="_blank" class="w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-eye text-[10px]"></i></a>` : ''}
                   ${hasL ? `<button onclick="showQR('${i.l}', '${i.n}')" class="w-8 h-8 flex items-center justify-center bg-emerald-50 text-emerald-600 rounded-lg"><i class="fas fa-qrcode text-[10px]"></i></button>` : ''}
                   ${role === 'admin' ? `<button onclick="delData(${i.id})" class="w-8 h-8 flex items-center justify-center bg-rose-50 text-rose-400 rounded-lg hover:bg-rose-600 hover:text-white transition-all"><i class="fas fa-trash-can text-[10px]"></i></button>` : ''}
               </div></td>
           </tr>`;
       }).join('');
       updateStats();
       renderChart();
   }

   function showQR(link, title) {
       document.getElementById("qrcode").innerHTML = "";
       new QRCode(document.getElementById("qrcode"), { text: link, width: 160, height: 160 });
       document.getElementById('qrTitle').innerText = title;
       openModal('qrModal');
   }

   document.getElementById('docForm').onsubmit = async (e) => {
       e.preventDefault();
       const nextNo = (db.length === 0) ? 1 : Math.max(...db.map(x => parseInt(x.noRaw))) + 1;
       const kode = document.getElementById('docCatType').value;
       const fullNo = `${nextNo.toString().padStart(3, '0')}/${kode}/${CONFIG.instansi}/${CONFIG.tahun}`;
       db.unshift({ id: Date.now(), noRaw: nextNo, formatNo: fullNo, n: document.getElementById('docName').value, k: document.getElementById('docGroup').value, l: document.getElementById('docLink').value, status: document.getElementById('docStatus').value, t: new Date().toLocaleDateString('id-ID') });
       renderTable(); await syncToCloud(); e.target.reset();
   };

   async function saveAgenda() {
       const nextNo = (db.length === 0) ? 1 : Math.max(...db.map(x => parseInt(x.noRaw))) + 1;
       const fullNo = `${nextNo.toString().padStart(3, '0')}/SM/${CONFIG.instansi}/${CONFIG.tahun}`;
       db.unshift({ id: Date.now(), noRaw: nextNo, formatNo: fullNo, n: `[MASUK] ${document.getElementById('agAsal').value} - ${document.getElementById('agPerihal').value}`, k: 'A', l: document.getElementById('agLink').value, status: 'Selesai', t: new Date().toLocaleDateString('id-ID') });
       renderTable(); closeModal('agendaModal'); await syncToCloud();
   }

   async function saveSuratKeluar() {
       const nextNo = (db.length === 0) ? 1 : Math.max(...db.map(x => parseInt(x.noRaw))) + 1;
       const kode = document.getElementById('skKode').value;
       const fullNo = `${nextNo.toString().padStart(3, '0')}/${kode}/${CONFIG.instansi}/${CONFIG.tahun}`;
       db.unshift({ id: Date.now(), noRaw: nextNo, formatNo: fullNo, n: `[KELUAR] ${kode} - KE: ${document.getElementById('skTujuan').value} - ${document.getElementById('skPerihal').value}`, k: 'A', l: '', status: 'Selesai', t: new Date().toLocaleDateString('id-ID') });
       renderTable(); closeModal('suratKeluarModal'); await syncToCloud();
   }

   function updateStats() {
       const cats = ['TOTAL', 'A', 'B', 'C', 'D', 'E', 'F'];
       document.getElementById('statsContainer').innerHTML = cats.map(k => {
           const val = k === 'TOTAL' ? db.length : db.filter(i => i.k === k).length;
           return `<div class="bg-white/10 border border-white/20 p-4 rounded-2xl text-center backdrop-blur-md"><div class="text-[8px] font-black uppercase text-white/60 mb-1">${k}</div><div class="text-xl font-black text-white">${val}</div></div>`;
       }).join('');
   }

   async function delData(id) { if(confirm("Hapus permanen?")) { db = db.filter(i => i.id !== id); renderTable(); await syncToCloud(); } }

   function exportToPDF() {
       const { jsPDF } = window.jspdf;
       const doc = new jsPDF();
       doc.text("LAPORAN ARSIP PUSKESMAS KIARAPEDES", 14, 20);
       doc.autoTable({ startY: 30, head: [['KODE', 'PERIHAL', 'STATUS', 'TGL']], body: db.map(i => [i.formatNo, i.n, i.status, i.t]), theme: 'grid' });
       doc.save('Arsip_PKM.pdf');
   }
</script>
</body>
</html>