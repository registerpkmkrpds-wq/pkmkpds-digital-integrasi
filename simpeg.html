<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG Digital | PKM Kiarapedes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; color: #f1f5f9; overflow-x: hidden; }
        
        .hero-gradient {
            background: radial-gradient(circle at top right, rgba(16, 185, 129, 0.1), transparent),
                        radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.1), transparent);
            min-height: 100vh;
        }

        .glass-panel { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); border-radius: 2rem; }
        
        input, select { background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; padding: 12px; border-radius: 1rem; outline: none; transition: 0.3s; }
        input:focus { border-color: #10b981 !important; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        
        th { color: #10b981; text-transform: uppercase; font-size: 10px; font-weight: 800; letter-spacing: 2px; padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: left; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        
        .btn-primary { background: #10b981; color: white; font-weight: 800; border-radius: 1rem; transition: 0.4s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4); }
        
        /* ID Card Styling */
        .id-card-canvas { width: 300px; height: 480px; background: linear-gradient(145deg, #064e3b, #020617); border-radius: 24px; position: relative; overflow: hidden; }
        .id-card-photo { width: 120px; height: 120px; border-radius: 20px; border: 3px solid #10b981; object-fit: cover; }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="hero-gradient p-4 md:p-8">

    <div id="loginOverlay" class="fixed inset-0 z-[9999] bg-slate-950 flex items-center justify-center p-6">
        <div class="glass-panel p-10 w-full max-w-md text-center border-emerald-500/20">
            <div class="w-20 h-20 bg-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-emerald-500/40">
                <i class="fas fa-shield-halved text-3xl"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 uppercase tracking-tighter text-white">Gateway <span class="text-emerald-500">SIMPEG</span></h2>
            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.3em] mb-8">Otentikasi Kepegawaian</p>
            <form id="loginForm" class="space-y-4 text-left">
                <input type="text" id="userInp" placeholder="Username" class="w-full" required>
                <input type="password" id="passInp" placeholder="Password" class="w-full" required>
                <button type="submit" class="btn-primary w-full py-4 mt-2">Masuk Sistem</button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="max-w-7xl mx-auto hidden">
        
        <header class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-hospital-user text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tighter text-white uppercase">SIMPEG <span class="text-emerald-500">DIGITAL</span></h1>
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.3em]">PKM Kiarapedes System</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="hidden md:block text-right">
                    <div id="clock" class="font-bold text-white text-xl"></div>
                    <p id="dateText" class="text-[9px] text-emerald-500 uppercase font-bold tracking-widest"></p>
                </div>
                <button onclick="logout()" class="bg-rose-500/10 text-rose-500 p-4 rounded-xl hover:bg-rose-500 hover:text-white transition">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-panel p-6 border-l-4 border-emerald-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">Total Pegawai</p>
                <h2 id="stat-total" class="text-3xl font-black text-white">0</h2>
            </div>
            <div class="glass-panel p-6 border-l-4 border-amber-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">Hadir Hari Ini</p>
                <h2 id="count-hadir" class="text-3xl font-black text-white">0</h2>
            </div>
            <div class="glass-panel p-6 border-l-4 border-rose-500">
                <p class="text-[10px] text-slate-500 uppercase font-bold">SIP Warning</p>
                <h2 id="stat-warning" class="text-3xl font-black text-rose-500">0</h2>
            </div>
            <div class="glass-panel p-6 bg-emerald-500/10 border-emerald-500/20">
                <p class="text-[10px] text-slate-500 uppercase font-bold mb-2">Sync Status</p>
                <p id="last-update" class="text-[10px] font-mono text-emerald-500">Syncing...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 no-print">
                <div class="glass-panel p-8 sticky top-8">
                    <h3 class="text-sm font-bold text-white mb-6 uppercase flex items-center gap-2">
                        <span class="w-2 h-6 bg-emerald-500 rounded-full"></span> Input Pegawai
                    </h3>
                    <form id="pegawaiForm" class="space-y-4">
                        <div class="flex items-center gap-4 mb-4">
                            <div id="imagePreview" class="w-16 h-16 rounded-xl bg-white/5 border-2 border-dashed border-white/20 flex items-center justify-center text-white/20 overflow-hidden">
                                <i class="fas fa-camera text-xl"></i>
                            </div>
                            <div class="flex-grow">
                                <label class="text-[10px] text-slate-500 block mb-1 uppercase font-bold">Foto Pegawai</label>
                                <input type="file" id="fotoPegawai" accept="image/*" class="text-[10px] w-full">
                            </div>
                        </div>
                        <input type="text" id="namaPegawai" placeholder="Nama Lengkap" class="w-full" required>
                        <input type="text" id="nipPegawai" placeholder="NIP/NRPTK" class="w-full">
                        <input type="tel" id="waPegawai" placeholder="628123xxx" class="w-full">
                        <select id="jabatanPegawai" class="w-full">
                            <option value="Medis">Tenaga Medis</option>
                            <option value="Paramedis">Tenaga Kesehatan</option>
                            <option value="Admin">Administrasi</option>
                            <option value="Umum">Umum</option>
                        </select>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[9px] text-slate-500 uppercase font-bold">Tgl Lahir</label><input type="date" id="tglLahir" class="w-full" required></div>
                            <div><label class="text-[9px] text-slate-500 uppercase font-bold">SIP Berlaku</label><input type="date" id="sipDeadline" class="w-full"></div>
                        </div>
                        <button type="submit" class="btn-primary w-full py-4 shadow-lg">SIMPAN DATA</button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="glass-panel p-6 mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex items-center gap-4 flex-grow max-w-md">
                        <i class="fas fa-search text-emerald-500"></i>
                        <input type="text" id="searchInput" oninput="renderTable()" placeholder="Cari nama atau NIP..." class="w-full !bg-transparent border-none">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportToExcel()" class="bg-emerald-600/20 text-emerald-500 border border-emerald-500/30 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-emerald-500 hover:text-white transition uppercase tracking-widest">
                            <i class="fas fa-file-excel mr-1"></i> Data
                        </button>
                        <button onclick="exportLaporanKehadiran()" class="bg-blue-600/20 text-blue-400 border border-blue-500/30 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-blue-500 hover:text-white transition uppercase tracking-widest">
                            <i class="fas fa-clipboard-check mr-1"></i> Laporan
                        </button>
                    </div>
                </div>

                <div class="glass-panel p-6 mb-8">
                     <p class="text-[10px] text-slate-500 uppercase font-bold mb-4">Distribusi Jabatan</p>
                     <div class="h-32"><canvas id="chartJabatan"></canvas></div>
                </div>

                <div class="glass-panel overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>Pegawai</th>
                                    <th>Status & SIP</th>
                                    <th>Hadir</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pegawaiTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="idCardModal" class="fixed inset-0 bg-slate-950/90 z-[2000] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="flex flex-col items-center max-w-sm w-full">
            <div id="idCard" class="id-card-canvas flex flex-col items-center p-8 text-white relative text-center">
                <div class="mb-6">
                    <p class="text-[7px] font-black tracking-[0.4em] text-emerald-500 uppercase">Pemerintah Kab. Purwakarta</p>
                    <h4 class="text-[9px] font-bold uppercase">UPTD Puskesmas Kiarapedes</h4>
                </div>
                <img id="printFoto" src="" class="id-card-photo shadow-2xl mb-4">
                <h2 id="printNama" class="text-xl font-black uppercase tracking-tighter leading-tight mb-1"></h2>
                <div id="printJabatan" class="inline-block px-3 py-1 bg-emerald-500/20 text-emerald-400 text-[10px] font-bold rounded-full uppercase tracking-widest mb-4"></div>
                <div class="bg-white p-2 rounded-xl inline-block mb-4 shadow-xl"><div id="qrcode"></div></div>
                <p id="printNip" class="text-[9px] font-mono opacity-50"></p>
                <div class="mt-auto pt-4 border-t border-white/10 w-full opacity-30 text-[7px] uppercase tracking-widest">Digital ID Card Petugas</div>
            </div>
            <div class="grid grid-cols-2 gap-3 w-full mt-8 no-print">
                <button onclick="downloadCard()" class="btn-primary py-3 text-[10px]">UNDUH JPG</button>
                <button onclick="document.getElementById('idCardModal').classList.replace('flex','hidden')" class="bg-white/10 text-white py-3 rounded-2xl text-[10px] font-bold">TUTUP</button>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[1000] no-print">
        <div class="bg-slate-900/80 backdrop-blur-xl border border-white/10 px-8 py-4 rounded-[2rem] flex items-center gap-10 shadow-2xl">
            <a href="index.html" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-home text-slate-500 group-hover:text-emerald-500 transition-all"></i>
                <span class="text-[7px] font-black uppercase text-slate-500">Portal</span>
            </a>
            <a href="e-arsip.html" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-box-archive text-slate-500 group-hover:text-emerald-500 transition-all"></i>
                <span class="text-[7px] font-black uppercase text-slate-500">Arsip</span>
            </a>
            <div class="flex flex-col items-center gap-1">
                <div class="w-1 h-1 bg-emerald-500 rounded-full mb-1"></div>
                <i class="fas fa-user-tie text-emerald-500"></i>
                <span class="text-[7px] font-black uppercase text-emerald-500">Simpeg</span>
            </div>
            <a href="analisis-data.html" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-chart-pie text-slate-500 group-hover:text-emerald-500 transition-all"></i>
                <span class="text-[7px] font-black uppercase text-slate-500">Analisis</span>
            </a>
        </div>
    </div>

    <script>
        // CONFIG SUPABASE
        const SUPABASE_URL = 'https://vxcgontdprrnotipdstx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Y2dvbnRkcHJybm90aXBkc3R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDU3NzUsImV4cCI6MjA4NTc4MTc3NX0.LgMMA5ysutL4sgHCDWZea20gvv9hwRQHPAX2BougW1U';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let dbPegawai = [];
        let jabatanChart;

        // AUTH & SSO LOGIC
        window.onload = function() {
            const isLogged = localStorage.getItem('pkm_isLoggedIn');
            if (isLogged === 'true') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadData();
            }
        };

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            if(document.getElementById('userInp').value === 'admin' && document.getElementById('passInp').value === 'pkm2026') {
                localStorage.setItem('pkm_isLoggedIn', 'true');
                localStorage.setItem('pkm_role', 'admin');
                location.reload();
            } else { alert("Akses Ditolak!"); }
        };

        function logout() { if(confirm("Keluar sistem?")) { localStorage.clear(); location.reload(); } }

        // DATA LOGIC
        async function loadData() {
            const { data, error } = await _supabase.from('pegawai').select('*').order('created_at', { ascending: false });
            if (error) return;
            dbPegawai = data;
            renderTable();
            updateDashboard();
        }

        function renderTable() {
            const body = document.getElementById('pegawaiTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const hariIni = new Date();
            body.innerHTML = '';

            dbPegawai.filter(p => p.nama.toLowerCase().includes(search) || (p.nip && p.nip.includes(search))).forEach(p => {
                let sipAlert = '<span class="text-emerald-500 text-[9px] font-bold">✔ AMAN</span>';
                if(p.sipDeadline) {
                    let diff = Math.ceil((new Date(p.sipDeadline) - hariIni) / (1000 * 60 * 60 * 24 * 30.44));
                    if(diff <= 6) sipAlert = `<span class="text-rose-500 font-bold text-[9px] animate-pulse">⚠️ ${diff} BLN</span>`;
                }

                body.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-white/5 transition">
                        <td>
                            <div class="flex items-center gap-3">
                                <img src="${p.foto || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-xl object-cover border border-white/10">
                                <div><b class="text-white text-sm">${p.nama}</b><br><small class="text-slate-500 uppercase text-[8px] tracking-widest">${p.jabatan}</small></div>
                            </div>
                        </td>
                        <td>${sipAlert}</td>
                        <td>
                            <select onchange="updateStatusHadir('${p.id}', this.value)" class="text-[9px] bg-slate-800 border-none py-1 px-2 rounded-md outline-none cursor-pointer">
                                <option value="Hadir" ${p.status_hadir === 'Hadir'?'selected':''}>HADIR</option>
                                <option value="Izin" ${p.status_hadir === 'Izin'?'selected':''}>IZIN</option>
                                <option value="Sakit" ${p.status_hadir === 'Sakit'?'selected':''}>SAKIT</option>
                                <option value="Cuti" ${p.status_hadir === 'Cuti'?'selected':''}>CUTI</option>
                            </select>
                        </td>
                        <td class="text-center">
                            <button onclick="bukaCetak('${p.id}')" class="text-emerald-500 mr-4 hover:scale-125 transition"><i class="fas fa-id-card"></i></button>
                            <button onclick="hapusData('${p.id}', '${p.nama}')" class="text-slate-600 hover:text-rose-500 transition"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `);
            });
        }

        async function updateStatusHadir(id, status) {
            await _supabase.from('pegawai').update({ status_hadir: status }).eq('id', id);
            loadData();
        }

        function updateDashboard() {
            const counts = { Medis: 0, Paramedis: 0, Admin: 0, Umum: 0 };
            let warningSip = 0; let hadirCount = 0;
            const hariIni = new Date();

            dbPegawai.forEach(p => {
                if(counts[p.jabatan] !== undefined) counts[p.jabatan]++;
                if(p.status_hadir === 'Hadir') hadirCount++;
                if(p.sipDeadline) {
                    let diff = (new Date(p.sipDeadline) - hariIni) / (1000 * 60 * 60 * 24 * 30.44);
                    if(diff <= 6 && diff > 0) warningSip++;
                }
            });

            document.getElementById('stat-total').innerText = dbPegawai.length;
            document.getElementById('stat-warning').innerText = warningSip;
            document.getElementById('count-hadir').innerText = hadirCount;
            document.getElementById('last-update').innerText = `Sync: ${new Date().toLocaleTimeString('id-ID')} WIB`;

            const ctx = document.getElementById('chartJabatan').getContext('2d');
            if(jabatanChart) jabatanChart.destroy();
            jabatanChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{ data: Object.values(counts), backgroundColor: '#10b981', borderRadius: 8 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { display: false } } } }
            });
        }

        // FEATURES
        function bukaCetak(id) {
            const p = dbPegawai.find(x => x.id == id);
            document.getElementById('printNama').innerText = p.nama;
            document.getElementById('printJabatan').innerText = p.jabatan;
            document.getElementById('printNip').innerText = `ID: ${p.nip || '-'}`;
            document.getElementById('printFoto').src = p.foto || 'https://via.placeholder.com/150';
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: `https://wa.me/${p.wa}`, width: 70, height: 70 });
            document.getElementById('idCardModal').classList.replace('hidden', 'flex');
        }

        async function downloadCard() {
            const canvas = await html2canvas(document.getElementById('idCard'), { scale: 3, useCORS: true });
            const link = document.createElement('a');
            link.download = `ID_CARD_${document.getElementById('printNama').innerText}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        async function exportLaporanKehadiran() {
            const data = dbPegawai.map(p => ({ "Nama": p.nama, "Jabatan": p.jabatan, "Status": p.status_hadir, "Sisa Cuti": (p.jatah_cuti || 12) - (p.cuti_terambil || 0) }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap");
            XLSX.writeFile(wb, "LAPORAN_BULANAN_SIMPEG.xlsx");
        }

        async function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(dbPegawai);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, "DATABASE_PEGAWAI.xlsx");
        }

        async function hapusData(id, nama) {
            if(confirm(`Hapus ${nama}?`)) { await _supabase.from('pegawai').delete().eq('id', id); loadData(); }
        }

        // FORM HANDLER
        document.getElementById('pegawaiForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "PROSES...";

            const file = document.getElementById('fotoPegawai').files[0];
            let fotoUrl = "";
            if(file) {
                const fName = `${Date.now()}-${file.name}`;
                const { data } = await _supabase.storage.from('avatars').upload(fName, file);
                if(data) fotoUrl = _supabase.storage.from('avatars').getPublicUrl(fName).data.publicUrl;
            }

            await _supabase.from('pegawai').insert([{
                nama: document.getElementById('namaPegawai').value,
                nip: document.getElementById('nipPegawai').value,
                wa: document.getElementById('waPegawai').value,
                jabatan: document.getElementById('jabatanPegawai').value,
                tglLahir: document.getElementById('tglLahir').value,
                sipDeadline: document.getElementById('sipDeadline').value,
                foto: fotoUrl
            }]);

            btn.disabled = false; btn.innerText = "SIMPAN DATA";
            e.target.reset(); document.getElementById('imagePreview').innerHTML = '<i class="fas fa-camera text-xl"></i>';
            loadData();
        };

        document.getElementById('fotoPegawai').onchange = function() {
            const [file] = this.files;
            if (file) document.getElementById('imagePreview').innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover">`;
        };

        setInterval(() => { 
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID'); 
            document.getElementById('dateText').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
        }, 1000);
    </script>
</body>
</html>
