<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Generator File</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Arial, sans-serif; }
        #pdf-content { background: white; width: 210mm; min-height: 297mm; padding: 20mm; margin: 20px auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); font-size: 11pt; color: #333; }
        .table-laporan { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10pt; }
        .table-laporan th, .table-laporan td { border: 1px solid #000; padding: 8px; text-align: center; }
        .table-laporan th { background-color: #f2f2f2; }
        .section-title { border-bottom: 2px solid #1b5e20; color: #1b5e20; font-weight: bold; margin-top: 20px; text-transform: uppercase; }
        .recommendation-box { background-color: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; margin-top: 15px; border-left: 5px solid #2e7d32; }
        .control-panel { max-width: 950px; margin: 20px auto; }
        .chart-container { height: 280px; margin: 20px 0; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="container no-print control-panel">
    <div class="card p-4 shadow-sm border-0">
        <h5 class="fw-bold text-success mb-3">Input Data (Teks atau Salinan Excel)</h5>
        <textarea id="rawInput" class="form-control mb-3" rows="8" placeholder="Contoh Tempel dari Excel:&#10;Program	Target	Capaian&#10;Imunisasi	95%	80%&#10;Stunting	14%	12%"></textarea>
        <div class="row g-2">
            <div class="col-md-5"><input type="password" id="apiKey" class="form-control" placeholder="OpenAI API Key"></div>
            <div class="col-md-4"><button onclick="analisisExcelAI()" class="btn btn-success w-100 fw-bold">ANALISA DATA & EXCEL âœ¨</button></div>
            <div class="col-md-3"><button onclick="downloadPDF()" class="btn btn-dark w-100">SIMPAN LAPORAN ðŸ“„</button></div>
        </div>
    </div>
</div>

<div id="pdf-content">
    <div class="text-center mb-4">
        <h4 class="fw-bold mb-1">LAPORAN ANALISIS CAPAIAN PROGRAM KESEHATAN</h4>
        <p class="text-muted small">Visualisasi Data & Rekomendasi Perbaikan Strategis AI</p>
    </div>

    <div id="outputArea">
        <p class="text-center text-muted mt-5">Data tabel, grafik, dan analisis akan muncul di sini.</p>
    </div>

    <div id="chartArea" style="display:none;">
        <div class="section-title">Grafik Perbandingan Capaian</div>
        <div class="chart-container"><canvas id="autoChart"></canvas></div>
    </div>
</div>

<script>
    let myChart = null;

    async function analisisExcelAI() {
        const text = document.getElementById('rawInput').value;
        const key = document.getElementById('apiKey').value;
        if(!key) return alert("Masukkan API Key Anda!");

        document.getElementById('outputArea').innerHTML = "<div class='text-center py-5'><div class='spinner-border text-success'></div><p class='mt-2'>Membaca data Excel & Menyusun Analisa...</p></div>";

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [{
                        role: "system",
                        content: "Anda analis data kesehatan. Tugas: 1. Jika input tab-separated (Excel), buat tabel HTML class='table-laporan'. 2. Buat ringkasan narasi. 3. Ekstrak angka grafik. 4. Berikan Analisa Gap & Rekomendasi Strategis. Output JSON: {tabel_html: string, ringkasan: string, data_grafik: {labels:[], values:[]}, analisa: string, rekomendasi: [string]}"
                    }, { role: "user", content: text }]
                })
            });

            const rawData = await response.json();
            const data = JSON.parse(rawData.choices[0].message.content);
            renderLaporanExcel(data);
        } catch (e) {
            alert("Terjadi kesalahan. Pastikan format data dan API Key benar.");
        }
    }

    function renderLaporanExcel(data) {
        let html = `
            <div class="section-title">I. Ringkasan Laporan</div>
            <p class="mt-2 text-justify">${data.ringkasan}</p>
            
            <div class="section-title">II. Tabel Data Capaian</div>
            <div class="mt-2">${data.tabel_html}</div>

            <div class="section-title">III. Analisa Masalah (Gap Analysis)</div>
            <p class="mt-2">${data.analisa}</p>

            <div class="recommendation-box">
                <h6 class="fw-bold">IV. REKOMENDASI PERBAIKAN & TINDAK LANJUT</h6>
                <ul class="mb-0">${data.rekomendasi.map(item => `<li>${item}</li>`).join('')}</ul>
            </div>
        `;
        document.getElementById('outputArea').innerHTML = html;
        document.getElementById('chartArea').style.display = 'block';
        updateChart(data.data_grafik.labels, data.data_grafik.values);
    }

    function updateChart(labels, values) {
        const ctx = document.getElementById('autoChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Capaian (%)', data: values, backgroundColor: '#1b5e20', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        html2pdf().from(element).set({
            margin: 0, filename: 'Laporan_Kesehatan_Excel_AI.pdf',
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }
</script>
</body>
</html>
