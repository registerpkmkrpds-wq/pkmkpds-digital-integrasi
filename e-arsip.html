<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Arsip Digital | PKM Kiarapedes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --border-color: #e2e8f0; }
        .dark { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --border-color: #334155; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); transition: all 0.3s ease; }
        .glass-header { background: linear-gradient(135deg, #064e3b 0%, #059669 100%); }
        .card-custom { background: var(--bg-card); border-radius: 1.25rem; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .input-modern { width: 100%; padding: 0.75rem 1rem; background: rgba(0,0,0,0.05); border: 2px solid transparent; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; outline: none; color: var(--text-main); }
        .input-modern:focus { border-color: #10b981; background: var(--bg-card); }
        .btn-action { width: 32px; height: 32px; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-10">

<div id="modalLogin" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-[2.5rem] text-center max-w-xs w-full shadow-2xl">
        <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl">
            <i class="fas fa-lock"></i>
        </div>
        <h2 class="font-black text-slate-800 uppercase tracking-tighter mb-2">Verifikasi Arsip</h2>
        <p class="text-[10px] text-slate-400 font-bold mb-6 uppercase">Masukkan PIN Otorisasi 2026</p>
        <input type="password" id="pinInput" class="input-modern text-center text-2xl mb-4 tracking-[0.5em]" placeholder="****">
        <button onclick="verifikasiPin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-black shadow-lg shadow-emerald-200 uppercase">Buka Arsip</button>
    </div>
</div>

<div id="mainContent" class="hidden">
    <header class="glass-header text-white pb-24">
        <div class="container mx-auto px-6 pt-10">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <i class="fas fa-folder-open text-4xl text-yellow-400"></i>
                    <div>
                        <h1 class="font-black text-2xl tracking-tighter italic uppercase leading-none">Arsip <span class="text-emerald-400">Digital</span></h1>
                        <p class="text-[9px] font-bold uppercase tracking-[0.3em] text-emerald-300">PUSKESMAS KIARAPEDES</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleTheme()" class="bg-white/10 hover:bg-white/20 p-3 rounded-full border border-white/20"><i id="themeIcon" class="fas fa-moon"></i></button>
                    <button onclick="togglePedoman()" class="bg-blue-600 hover:bg-blue-500 p-3 rounded-full border border-blue-400 shadow-lg"><i class="fas fa-book-open text-xs"></i></button>
                    <button onclick="syncFromGAS()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full text-[10px] font-black uppercase flex items-center gap-2">
                        <i id="syncIcon" class="fas fa-sync-alt"></i> Sync Cloud
                    </button>
                    <button onclick="logout()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-rose-500 transition-all">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 -mt-16">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="card-custom p-6">
                    <form id="formArsip" class="space-y-4">
                        <div class="bg-emerald-50 dark:bg-emerald-950/40 p-4 rounded-xl border border-emerald-100">
                            <p class="text-[9px] font-black text-emerald-700 uppercase mb-1">Preview Nomor Surat:</p>
                            <h4 id="displayNomor" class="font-mono font-bold text-xs text-slate-700 leading-tight">---</h4>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Klaster</label>
                            <select id="selKlaster" class="input-modern" onchange="updateSub()"></select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Sub Klasifikasi</label>
                            <select id="selSub" class="input-modern" onchange="generatePreview()"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="noUrut" class="input-modern" placeholder="No Urut" oninput="generatePreview()">
                            <input type="date" id="arsipTgl" class="input-modern" onchange="generatePreview()">
                        </div>
                        <textarea id="arsipNama" class="input-modern h-16" placeholder="PERIHAL / NAMA DOKUMEN..."></textarea>

                        <div class="relative">
                            <input type="file" id="arsipFile" class="hidden" accept="application/pdf">
                            <label for="arsipFile" id="labelFile" class="w-full flex items-center justify-center gap-3 p-3 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 text-[10px] font-bold text-slate-500">
                                <i class="fas fa-file-pdf text-emerald-500 text-lg"></i> PILIH PDF (MAX 2MB)
                            </label>
                        </div>

                        <button type="submit" id="btnSimpan" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl uppercase text-xs shadow-lg hover:bg-emerald-500 transition-all">Simpan & Upload Ke Cloud</button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="card-custom p-4 mb-6 flex items-center gap-4">
                    <i class="fas fa-search text-slate-300 ml-2"></i>
                    <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari nomor atau perihal..." class="w-full bg-transparent outline-none font-bold text-xs">
                </div>
                <div class="card-custom overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse text-[11px]">
                            <thead class="bg-slate-50 dark:bg-slate-800 uppercase font-black text-slate-500 text-[9px]">
                                <tr>
                                    <th class="p-4">Informasi Dokumen</th>
                                    <th class="p-4 text-center">QR & Label</th>
                                    <th class="p-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="modalQR" class="fixed inset-0 bg-black/80 z-[4000] hidden flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-[2rem] text-center max-w-xs w-full shadow-2xl">
        <h3 id="qrTitle" class="font-black text-[10px] uppercase mb-4 text-slate-400"></h3>
        <div id="qrcode" class="flex justify-center mb-6 p-4 bg-white border rounded-2xl"></div>
        <button onclick="closeQR()" class="w-full bg-slate-900 text-white py-3 rounded-xl text-[10px] font-black uppercase">Tutup</button>
    </div>
</div>

<div id="modalPedoman" class="fixed inset-0 bg-black/80 z-[9500] hidden flex items-center justify-center p-4 backdrop-blur-md">
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] max-w-2xl w-full max-h-[85vh] overflow-hidden flex flex-col">
        <div class="p-8 border-b dark:border-slate-800 flex justify-between">
            <h2 class="text-xl font-black uppercase text-emerald-600 italic">Pedoman Penomoran</h2>
            <button onclick="togglePedoman()"><i class="fas fa-times text-slate-400"></i></button>
        </div>
        <div id="pedomanContent" class="p-8 overflow-y-auto custom-scrollbar space-y-4"></div>
    </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxleegy4EoSyyYRh2_A_E-P48UdcWhxsNJsmizzRzvov_svVJok1uUBHQ99GEjKIq-sIA/exec";
const PIN_HASH = "MjAyNg==";
let fileData = null;
let editIndex = null;
let database = JSON.parse(localStorage.getItem('db_arsip_ilp_final')) || [];

const KLASTER = {
    "Klaster 1: Manajemen": ["440.11 (RUK)", "440.12 (RPK)", "440.2 (Org)", "005 (Minlok)", "800 (Kepegawaian)", "900 (Keuangan)"],
    "Klaster 2: Ibu & Anak": ["441.11 (ANC)", "441.12 (PNC)", "441.21 (Imunisasi)", "441.22 (Stunting)", "441.31 (UKS)"],
    "Klaster 3: Dewasa & Lansia": ["440.51 (PTM)", "440.52 (IVA)", "440.53 (Jiwa)", "441.61 (Lansia)"],
    "Klaster 4: P2P & Kesling": ["443.11 (TB)", "443.12 (HIV)", "443.21 (DBD)", "448.1 (STBM)"],
    "Lintas Klaster": ["442.1 (Obat)", "445.1 (Lab)", "440.61 (Promkes)"]
};

const KLASTER_DETAIL = {
    "440.11": "Rencana Usulan Kegiatan", "440.12": "Rencana Pelaksanaan Kegiatan", "440.2": "Organisasi", "005": "Minilokarya", "800": "Kepegawaian", "900": "Keuangan", "441.11": "Ibu Hamil", "443.11": "TB/Kusta"
};

function verifikasiPin() {
    if (btoa(document.getElementById('pinInput').value) === PIN_HASH) {
        document.getElementById('modalLogin').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        initApp();
    } else { alert("PIN SALAH!"); }
}

function initApp() {
    const kSel = document.getElementById('selKlaster');
    kSel.innerHTML = Object.keys(KLASTER).map(k => `<option value="${k}">${k}</option>`).join('');
    updateSub(); renderTable();
}

function updateSub() {
    const k = document.getElementById('selKlaster').value;
    document.getElementById('selSub').innerHTML = KLASTER[k].map(s => `<option value="${s}">${s}</option>`).join('');
    generatePreview();
}

function generatePreview() {
    const s = document.getElementById('selSub').value;
    const kode = s.split(' ')[0].trim();
    const no = (document.getElementById('noUrut').value || "0").padStart(3, '0');
    const thn = new Date(document.getElementById('arsipTgl').value || new Date()).getFullYear();
    const nomor = `${kode}/${no}/PKM-KPDS/${thn}`;
    document.getElementById('displayNomor').innerHTML = nomor;
    return nomor;
}

// --- FILE HANDLING ---
document.getElementById('arsipFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('labelFile').innerHTML = `<i class="fas fa-check-circle text-emerald-500"></i> ${file.name}`;
    const reader = new FileReader();
    reader.onload = (ev) => fileData = { base64: ev.target.result.split(',')[1], name: file.name, type: file.type };
    reader.readAsDataURL(file);
};

// --- SIMPAN DATA (POST KE GAS) ---
document.getElementById('formArsip').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnSimpan');

    // Validasi Dasar
    if (!fileData && editIndex === null) {
        alert("Mohon pilih file PDF terlebih dahulu!");
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> MENGIRIM DATA...';

    const payload = {
        action: editIndex !== null ? "update" : "upload",
        no: generatePreview(),
        nama: document.getElementById('arsipNama').value.toUpperCase(),
        klaster: document.getElementById('selKlaster').value,
        sub: document.getElementById('selSub').value,
        tgl: document.getElementById('arsipTgl').value || new Date().toISOString().split('T')[0],
        fileData: fileData ? fileData.base64 : null,
        fileName: fileData ? fileData.name : "",
        fileType: fileData ? fileData.type : "",
        token: "2026"
    };

    try {
        // PERHATIAN: Jangan gunakan mode: "no-cors" jika ingin membaca respon JSON
        const response = await fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.status === "success") {
            const entry = {
                ...payload,
                link: result.url || (editIndex !== null ? database[editIndex].link : "#")
            };
            delete entry.fileData; // Hapus base64 agar penyimpanan lokal tidak penuh

            if (editIndex !== null) {
                database[editIndex] = entry;
            } else {
                database.unshift(entry);
            }

            localStorage.setItem('db_arsip_ilp_final', JSON.stringify(database));
            alert("✅ Berhasil! Data telah tersimpan di Cloud.");
            resetFormAfterSave();
            renderTable();
        } else {
            throw new Error(result.message || "Gagal menyimpan di Server.");
        }
    } catch (err) {
        console.error(err);
        alert("❌ ERROR: " + err.message + "\n\nPastikan koneksi internet stabil dan GAS URL benar.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Simpan & Upload Ke Cloud';
    }
};

function renderTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filtered = database.filter(x => x.no.toLowerCase().includes(search) || x.nama.toLowerCase().includes(search));

    document.getElementById('tableBody').innerHTML = filtered.map((x, i) => `
        <tr class="border-b hover:bg-slate-50">
            <td class="p-4">
                <span class="font-mono text-emerald-600 font-black">${x.no}</span>
                <div class="font-black text-slate-800 uppercase text-[10px]">${x.nama}</div>
                <div class="text-[9px] text-slate-400 font-bold uppercase">${x.tgl}</div>
            </td>
            <td class="p-4 text-center">
                <div class="flex justify-center gap-2">
                    <button onclick="showQR('${x.no}')" class="btn-action bg-slate-100"><i class="fas fa-qrcode"></i></button>
                    <button onclick="printLabel(${i})" class="btn-action bg-emerald-50 text-emerald-600"><i class="fas fa-tag"></i></button>
                </div>
            </td>
            <td class="p-4">
                <div class="flex justify-center gap-2">
                    <a href="${x.link}" target="_blank" class="btn-action bg-blue-50 text-blue-600"><i class="fas fa-eye"></i></a>
                    <button onclick="editData(${i})" class="btn-action bg-amber-50 text-amber-600"><i class="fas fa-edit"></i></button>
                    <button onclick="hapus(${i})" class="btn-action bg-rose-50 text-rose-600"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        </tr>`).join('');
}

function editData(i) {
    const item = database[i];
    document.getElementById('arsipNama').value = item.nama;
    document.getElementById('noUrut').value = item.no.split('/')[1];
    document.getElementById('arsipTgl').value = item.tgl;
    editIndex = i;
    document.getElementById('btnSimpan').innerText = "Update Data";
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function hapus(i) {
    if(confirm("Hapus data ini?")) {
        database.splice(i, 1);
        localStorage.setItem('db_arsip_ilp_final', JSON.stringify(database));
        renderTable();
    }
}

async function syncFromGAS() {
    const icon = document.getElementById('syncIcon');
    icon.classList.add('fa-spin');
    try {
        const res = await fetch(GAS_URL);
        database = await res.json();
        localStorage.setItem('db_arsip_ilp_final', JSON.stringify(database));
        renderTable();
        alert("Sinkronisasi Berhasil!");
    } catch(e) { alert("Gagal Sync!"); }
    finally { icon.classList.remove('fa-spin'); }
}

function showQR(t) {
    document.getElementById('modalQR').classList.remove('hidden');
    document.getElementById('qrTitle').innerText = t;
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { text: t, width: 150, height: 150 });
}

function togglePedoman() {
    const m = document.getElementById('modalPedoman');
    if(m.classList.contains('hidden')) {
        let h = `<div class="bg-blue-50 p-4 rounded-xl mb-4 text-[11px] font-mono text-blue-700 border border-blue-200">FORMAT: [KODE] / [NO URUT] / PKM-KPDS / [TAHUN]</div>`;
        Object.keys(KLASTER).forEach(k => {
            const s = CLUSTER_STYLES[k];
            h += `<div class="p-4 border dark:border-slate-800 rounded-xl">
                <div class="flex items-center gap-2 mb-2 font-black text-xs ${s.color}"><i class="fas ${s.icon}"></i> ${k}</div>
                <div class="flex flex-wrap gap-1">${KLASTER[k].map(c => `<span class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-[9px] font-bold">${c}</span>`).join('')}</div>
            </div>`;
        });
        document.getElementById('pedomanContent').innerHTML = h;
        m.classList.remove('hidden');
    } else { m.classList.add('hidden'); }
}

function closeQR() { document.getElementById('modalQR').classList.add('hidden'); }
function logout() { localStorage.clear(); window.location.href = 'index.html'; }
function toggleTheme() { document.documentElement.classList.toggle('dark'); }

</script>
</body>
</html>
