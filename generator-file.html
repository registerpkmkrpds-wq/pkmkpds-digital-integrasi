<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Analis Kesehatan Pro - Gemini Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        #pdf-content { background: white; width: 210mm; min-height: 297mm; padding: 20mm; margin: 20px auto; box-shadow: 0 0 15px rgba(0,0,0,0.1); color: #333; }
        .table-laporan { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .table-laporan th, .table-laporan td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 10pt; }
        .table-laporan th { background-color: #f2f2f2; }
        .section-title { border-bottom: 2px solid #0d6efd; color: #0d6efd; font-weight: bold; margin-top: 20px; text-transform: uppercase; }
        .recommendation-box { background-color: #e7f1ff; border-left: 5px solid #0d6efd; padding: 15px; margin-top: 15px; }
        .control-panel { max-width: 900px; margin: 20px auto; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

<div class="container no-print control-panel">
    <div class="card p-4 shadow-sm border-0">
        <h5 class="fw-bold text-primary mb-3">Input Data Gemini AI (Gratis)</h5>
        <textarea id="rawInput" class="form-control mb-3" rows="6" placeholder="Tempel data Excel atau narasi kasar di sini..."></textarea>
        <div class="row g-2">
            <div class="col-md-5"><input type="password" id="apiKey" class="form-control" placeholder="Masukkan Gemini API Key"></div>
            <div class="col-md-4"><button onclick="analisisGemini()" class="btn btn-primary w-100 fw-bold">PROSES ANALISA âœ¨</button></div>
            <div class="col-md-3"><button onclick="downloadPDF()" class="btn btn-dark w-100">SIMPAN PDF ðŸ“„</button></div>
        </div>
        <small class="text-muted mt-2 d-block text-center">Dapatkan API Key gratis di: <a href="https://aistudio.google.com/" target="_blank">aistudio.google.com</a></small>
    </div>
</div>

<div id="pdf-content">
    <div class="text-center mb-4">
        <h4 class="fw-bold mb-1">LAPORAN ANALISIS PROGRAM KESEHATAN</h4>
        <p class="text-muted small" id="tglLaporan"></p>
    </div>
    <div id="outputArea"><p class="text-center text-muted mt-5">Data akan muncul di sini setelah diproses.</p></div>
    <div id="chartArea" style="display:none;" class="mt-4">
        <div class="section-title">Grafik Capaian</div>
        <div style="height: 250px;"><canvas id="autoChart"></canvas></div>
    </div>
</div>

<script>
    let myChart = null;

    async function analisisGemini() {
        const text = document.getElementById('rawInput').value;
        const key = document.getElementById('apiKey').value;
        if(!key) return alert("Masukkan API Key Gemini!");

        localStorage.setItem('gemini_key', key);
        document.getElementById('outputArea').innerHTML = "<div class='text-center py-5'>AI sedang bekerja...</div>";

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

        const prompt = `Bertindaklah sebagai analis kesehatan. Rapikan input ini (bisa berupa teks atau tab-separated dari excel). 
        Berikan JSON murni tanpa markdown: { "ringkasan": "string", "tabel_html": "string tabel class='table-laporan'", "data_grafik": {"labels":[], "values":[]}, "analisa": "string", "rekomendasi": ["string"] }.
        Input: ${text}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const resData = await response.json();
            const cleanJson = resData.candidates[0].content.parts[0].text.replace(/```json|```/g, "");
            const data = JSON.parse(cleanJson);
            renderLaporan(data);
        } catch (e) {
            alert("Error: Pastikan API Key benar dan internet aktif.");
        }
    }

    function renderLaporan(data) {
        document.getElementById('outputArea').innerHTML = `
            <div class="section-title">I. Ringkasan</div><p>${data.ringkasan}</p>
            <div class="section-title">II. Data Tabel</div><div class="table-responsive">${data.tabel_html}</div>
            <div class="section-title">III. Analisa Masalah</div><p>${data.analisa}</p>
            <div class="recommendation-box"><strong>IV. Rekomendasi:</strong><ul>${data.rekomendasi.map(r => `<li>${r}</li>`).join('')}</ul></div>
        `;
        document.getElementById('chartArea').style.display = 'block';
        updateChart(data.data_grafik.labels, data.data_grafik.values);
    }

    function updateChart(labels, values) {
        const ctx = document.getElementById('autoChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: '% Capaian', data: values, backgroundColor: '#0d6efd' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function downloadPDF() {
        html2pdf().from(document.getElementById('pdf-content')).save('Laporan_Gemini_AI.pdf');
    }

    window.onload = () => {
        document.getElementById('tglLaporan').innerText = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        if(localStorage.getItem('gemini_key')) document.getElementById('apiKey').value = localStorage.getItem('gemini_key');
    };
</script>
</body>
</html>
