<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPEG Digital | PKM Kiarapedes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f1f5f9; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        input, select { background: rgba(255, 255, 255, 0.03) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: white !important; font-size: 11px; }
        .loader { border-top-color: #10b981; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8" onload="loadData()">
    
<a href="index.html" class="flex flex-col items-center gap-1 group text-slate-500 hover:text-emerald-400 transition-all">
            <i class="fas fa-home text-[14px]"></i>
            <span class="text-[8px] font-bold uppercase tracking-tighter">Kembali Ke Menu</span>
        </a>
    
    <nav class="max-w-7xl mx-auto glass rounded-3xl mb-8 px-6 py-4 flex items-center justify-between no-print">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-robot text-white text-xl"></i></div>
            <div>
                <h1 class="text-sm font-black uppercase tracking-tight">SIMPEG <span class="text-emerald-500">KIARAPEDES</span></h1>
                <p class="text-[8px] text-slate-500 font-bold uppercase tracking-widest text-emerald-500/80">Auto-Folder Cloud v11.0</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="downloadBatchReport()" class="bg-indigo-600/10 text-indigo-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase border border-indigo-500/20">
                <i class="fas fa-file-excel mr-1"></i> Excel Report
            </button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4">
                <div class="glass p-6 rounded-3xl sticky top-8">
                    <h3 class="text-[10px] font-black mb-6 uppercase text-emerald-500 tracking-widest"><i class="fas fa-folder-plus mr-2"></i>Tambah Pegawai Baru</h3>
                    <form id="pegawaiForm" class="space-y-4">
                        <input type="text" id="namaPegawai" placeholder="Nama Lengkap & Gelar" class="w-full p-3 rounded-xl" required>
                        <input type="text" id="nipPegawai" placeholder="NIP / NI PPPK" class="w-full p-3 rounded-xl" required>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="golonganPegawai" placeholder="Golongan" class="w-full p-3 rounded-xl">
                            <select id="jabatanPegawai" class="w-full p-3 rounded-xl">
                                <option value="Medis">Tenaga Medis</option>
                                <option value="Paramedis">Tenaga Kesehatan</option>
                                <option value="Administrasi">Tenaga Administrasi</option>
                                <option value="Administrasi">Tenaga Lainnya</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-[9px] text-slate-500 uppercase font-bold ml-1">KGB Terakhir</label><input type="date" id="tmtKgb" class="w-full p-3 rounded-xl" required></div>
                            <div><label class="text-[9px] text-rose-400 uppercase font-bold ml-1">SIP Expired</label><input type="date" id="expSip" class="w-full p-3 rounded-xl"></div>
                        </div>

                        <button type="submit" id="btnSimpan" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black uppercase text-[10px] transition-all flex items-center justify-center gap-2">
                            <span id="btnText">Simpan</span>
                            <div id="btnLoader" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </button>
                    </form>
                    <p class="text-[8px] text-slate-500 mt-4 italic text-center text-balance">*Sistem akan otomatis membuat folder Google Drive dengan format: <b>NIP_Nama</b></p>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="glass rounded-3xl overflow-hidden shadow-2xl">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-white/5 text-[9px] font-black uppercase text-slate-400 border-b border-white/10">
                            <tr>
                                <th class="p-5">Profil Pegawai</th>
                                <th class="p-5">Monitoring</th>
                                <th class="p-5 text-right">Kelola Arsip</th>
                            </tr>
                        </thead>
                        <tbody id="pegawaiTableBody" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIGURATION
        const SUPABASE_URL = 'https://vxcgontdprrnotipdstx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4Y2dvbnRkcHJybm90aXBkc3R4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMDU3NzUsImV4cCI6MjA4NTc4MTc3NX0.LgMMA5ysutL4sgHCDWZea20gvv9hwRQHPAX2BougW1U';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwO8_r8qaEMprg0k5jwnYiOFUwbfyWF0THVLbv-VjEREift6vE75FyIGerd_3xF8mzfCw/exec'; // URL dari Deploy GAS
        
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let dbPegawai = [];

        async function loadData() {
            const { data } = await _supabase.from('pegawai').select('*').order('nama');
            dbPegawai = data || [];
            renderTable();
        }

        function renderTable() {
            const body = document.getElementById('pegawaiTableBody');
            body.innerHTML = '';
            dbPegawai.forEach(p => {
                const sip = getSipStatus(p.exp_sip);
                body.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-white/[0.02] transition">
                        <td class="p-5">
                            <b class="uppercase block text-white">${p.nama}</b>
                            <span class="text-[8px] font-bold text-slate-500 tracking-widest">${p.nip}</span>
                        </td>
                        <td class="p-5">
                            <span class="px-2 py-0.5 rounded-[4px] font-black text-[7px] ${sip.bg} ${sip.color}">${sip.label}</span>
                        </td>
                        <td class="p-5 text-right flex justify-end gap-2">
                            <a href="${p.link_drive}" target="_blank" class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-500 border border-blue-500/20 flex items-center justify-center hover:bg-blue-500 hover:text-white transition">
                                <i class="fab fa-google-drive"></i>
                            </a>
                            <button onclick="buatSurat('${p.id}')" class="w-8 h-8 rounded-lg bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 flex items-center justify-center hover:bg-emerald-500 hover:text-white transition">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        }

        function getSipStatus(dateString) {
            if (!dateString) return { label: 'NO SIP DATA', color: 'text-slate-500', bg: 'bg-white/5' };
            const exp = new Date(dateString);
            const now = new Date();
            const diff = (exp - now) / (1000 * 60 * 60 * 24 * 30.44);
            if (diff < 0) return { label: 'SIP EXPIRED', color: 'text-rose-500', bg: 'bg-rose-500/20' };
            if (diff <= 6) return { label: 'SIP KRITIS', color: 'text-amber-500', bg: 'bg-amber-500/20' };
            return { label: 'SIP AKTIF', color: 'text-emerald-500', bg: 'bg-emerald-500/20' };
        }

        // FUNGSI SIMPAN DENGAN AUTO-FOLDER
       document.getElementById('pegawaiForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnSimpan');
    
    // Ambil data dan Rapikan (Trim & Uppercase)
    const id = document.getElementById('editId').value;
    const nama = document.getElementById('namaPegawai').value.toUpperCase().trim();
    const nip = document.getElementById('nipPegawai').value.replace(/\s/g, ''); // Hapus spasi jika ada
    let drive = document.getElementById('linkDrive').value;

    // Validasi NIP Standar (18 Digit)
    if (nip.length !== 18 && !confirm("NIP biasanya 18 digit. Lanjutkan simpan?")) {
        return;
    }

    btn.innerText = "Processing...";
    btn.disabled = true;

    try {
        // Jika Link Drive Kosong & Tidak sedang Edit -> Buat Otomatis via GAS
        if(!drive && !id) {
            const res = await fetch(`${GAS_URL}?nama=${encodeURIComponent(nama)}&nip=${encodeURIComponent(nip)}`);
            drive = await res.text();
        }

        const payload = {
            nama, nip, 
            jabatan: document.getElementById('jabatanPegawai').value,
            golongan: document.getElementById('golonganPegawai').value,
            tmt_kgb: document.getElementById('tmtKgb').value,
            exp_sip: document.getElementById('expSip').value,
            link_drive: drive
        };

        if(id) {
            await _supabase.from('pegawai').update(payload).eq('id', id);
        } else {
            await _supabase.from('pegawai').insert([payload]);
        }

        alert('Data Berhasil Disinkronkan!');
        resetForm();
        loadData();
    } catch (err) {
        alert('Gagal: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "SIMPAN DATA";
    }
};
        
        // FUNGSI EXPORT EXCEL DENGAN STATUS MONITORING (FIXED & ENHANCED)
function downloadBatchReport() {
    if (dbPegawai.length === 0) {
        alert("Tidak ada data untuk diekspor.");
        return;
    }

    // Menyusun data yang akan diekspor
    const dataEksport = dbPegawai.map(p => {
        // Logika Status SIP untuk Excel
        let statusSIP = "TIDAK ADA DATA";
        if (p.exp_sip) {
            const diff = (new Date(p.exp_sip) - new Date()) / (1000 * 60 * 60 * 24 * 30.44);
            if (diff < 0) statusSIP = "EXPIRED";
            else if (diff <= 6) statusSIP = "KRITIS (SEGERA URUS)";
            else statusSIP = "AKTIF";
        }

        return {
            'Nama Pegawai': p.nama,
            'NIP': p.nip,
            'Jabatan': p.jabatan,
            'Golongan': p.golongan,
            'TMT KGB': p.tmt_kgb,
            'SIP Expired': p.exp_sip || '-',
            'Status SIP': statusSIP, // Kolom Tambahan Baru
            'Estimasi Pensiun': hitungPensiun(p.nip),
            'Link Arsip Digital': p.link_drive
        };
    });

    // Proses Pembuatan Sheet menggunakan library XLSX
    try {
        const worksheet = XLSX.utils.json_to_sheet(dataEksport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data_Pegawai");

        // Pengaturan lebar kolom otomatis (opsional)
        worksheet['!cols'] = [
            { wch: 30 }, // Nama
            { wch: 20 }, // NIP
            { wch: 15 }, // Jabatan
            { wch: 10 }, // Golongan
            { wch: 12 }, // TMT KGB
            { wch: 12 }, // SIP Exp
            { wch: 20 }, // Status SIP
            { wch: 15 }, // Pensiun
            { wch: 50 }  // Link Drive
        ];

        // Menghasilkan File Excel
        const tgl = new Date().toLocaleDateString('id-ID').replace(/\//g, '-');
        XLSX.writeFile(workbook, `REKAP_SIMPEG_KIARAPEDES_${tgl}.xlsx`);
    } catch (err) {
        console.error("Gagal Export:", err);
        alert("Terjadi kesalahan saat membuat file Excel.");
    }
}
    </script>
</body>
</html>
