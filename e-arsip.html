<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Arsip Digital | PKM Kiarapedes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    (function() {
        const token = localStorage.getItem('pkm_session');
        const time = localStorage.getItem('pkm_session_time');
        const now = new Date().getTime();
        const expiry = 4 * 60 * 60 * 1000;

        // Cek apakah data benar-benar tidak ada
        if (!token || !time || (now - time > expiry)) {
            console.log("Akses ditolak, mengalihkan...");
            localStorage.clear();
            // Arahkan ke index.html di folder yang sama
            window.location.replace("./index.html");
        }
    })();
</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --bg-body: #f8fafc; --bg-card: #ffffff; --text-main: #1e293b; --border-color: #e2e8f0; }
        .dark { --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f1f5f9; --border-color: #334155; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-body); color: var(--text-main); transition: all 0.3s ease; }
        .glass-header { background: linear-gradient(135deg, #064e3b 0%, #059669 100%); }
        .card-custom { background: var(--bg-card); border-radius: 1.25rem; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .input-modern { width: 100%; padding: 0.75rem 1rem; background: rgba(0,0,0,0.05); border: 2px solid transparent; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; outline: none; color: var(--text-main); }
        .input-modern:focus { border-color: #10b981; background: var(--bg-card); }
        .btn-action { width: 32px; height: 32px; border-radius: 8px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .stat-card { border-left: 4px solid #10b981; }
    </style>
</head>
<body class="pb-10">

<div id="modalLogin" class="fixed inset-0 bg-slate-900 z-[2000] flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-[2.5rem] text-center max-w-xs w-full shadow-2xl">
        <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl">
            <i class="fas fa-lock"></i>
        </div>
        <h2 class="font-black text-slate-800 uppercase tracking-tighter mb-2">Verifikasi Akses</h2>
        <p class="text-[10px] text-slate-400 font-bold mb-6 uppercase">Masukkan PIN Otorisasi 2026</p>
        <input type="password" id="pinInput" class="input-modern text-center text-2xl mb-4 tracking-[0.5em]" placeholder="****">
        <button onclick="verifikasiPin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-black shadow-lg shadow-emerald-200 uppercase">Masuk Sistem</button>
    </div>
</div>

<div id="mainContent" class="hidden">
   <header class="glass-header text-white pb-24">
    <div class="container mx-auto px-6 pt-10">
        <div class="flex justify-between items-center">
            
    <div class="flex items-center gap-3">
    <i class="fas fa-folder-open" style="font-size:38px;color:yellow/20"></i><div>
    <h1 class="font-black text-2xl tracking-tighter italic uppercase leading-none">Arsip <span class="text-emerald-400">Digital</span></h1>
    <p class="text-[9px] font-bold uppercase tracking-[0.3em] text-emerald-300">PUSKESMAS KIARAPEDES</p></div>
</div>
</div>

        <div class="flex items-center gap-3">
            <button onclick="exportToExcel()" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full border border-white/20 text-[10px] font-black uppercase">
                <i class="fas fa-file-excel mr-2"></i> Export
                </button>
            <button onclick="syncFromGAS()" class="flex items-center gap-2 bg-red-700 hover:bg-red-600 px-4 py-2 rounded-full border border-emerald-400/30 transition-all text-[10px] font-black uppercase">
                <i id="syncIcon" class="fas fa-sync-alt"></i> Sync
                 </button>
            <button onclick="toggleBantuan()" class="flex items-center gap-2 bg-blue-500 hover:bg-orange-500 px-4 py-2 rounded-full border border-blue-400/30 transition-all">
                <i class="fas fa-question-circle text-[10px] text-blue-200"></i><span class="text-[10px] font-bold uppercase text-white">Bantuan</span>
               <button onclick="toggleTheme()" class="text-white hover:opacity-75 transition-all focus:outline-none p-2">
                  <i id="theme-icon" class="fas fa-moon" style="font-size:20px"></i>
                </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 -mt-16">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <div class="card-custom p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-[10px] font-black uppercase text-slate-400 italic">Ringkasan Arsip</h3>
                        <span id="totalArsip" class="bg-emerald-100 text-emerald-700 text-xs font-black px-3 py-1 rounded-full">0 Data</span>
                    </div>
                    <div id="sebaranKlaster" class="space-y-2">
                        </div>
                </div>

                <div class="card-custom p-6">
                    <form id="formArsip" class="space-y-4">
                        <div class="bg-emerald-50 dark:bg-emerald-950/40 p-4 rounded-xl border border-emerald-100 dark:border-emerald-800">
                            <p class="text-[9px] font-black text-emerald-700 uppercase mb-1 italic">Preview Nomor Surat:</p>
                            <h4 id="displayNomor" class="font-mono font-bold text-xs text-slate-700 dark:text-emerald-300 leading-tight">---</h4>
                        </div>

                          <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Klaster</label>
                            <select id="selKlaster" class="input-modern" onchange="updateSub()"></select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Sub Klasifikasi</label>
                            <select id="selSub" class="input-modern" onchange="generatePreview()"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="noUrut" class="input-modern" placeholder="No Urut" oninput="generatePreview()">
                            <input type="date" id="arsipTgl" class="input-modern" onchange="generatePreview()">
                        </div>
                        <textarea id="arsipNama" class="input-modern h-16" placeholder="PERIHAL / NAMA DOKUMEN..."></textarea>

                        <div class="relative">
                            <input type="file" id="arsipFile" class="hidden" accept="application/pdf">
                            <label for="arsipFile" class="w-full flex items-center justify-center gap-3 p-3 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-all text-[10px] font-bold text-slate-500">
                                <i class="fas fa-file-pdf text-emerald-500 text-lg"></i> UPLOAD PDF (MAX 2MB)
                            </label>
                        </div>

                        <button type="submit" id="btnSimpan" class="w-full bg-emerald-600 text-white font-black py-4 rounded-xl uppercase text-xs shadow-lg shadow-emerald-200/50 hover:bg-emerald-500 transition-all">Simpan & Upload Ke Cloud</button>                              
                    </form>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="card-custom p-4 mb-6 flex items-center gap-4">
                    <i class="fas fa-search text-slate-300 ml-2"></i>
                    <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari nomor atau perihal..." class="w-full bg-transparent outline-none font-bold text-xs">
                    <select id="filterKlaster" onchange="renderTable()" class="bg-slate-50 dark:bg-slate-800 border-none outline-none text-[10px] font-black uppercase p-2 rounded-lg text-slate-500">
                        <option value="Semua">Semua Klaster</option>
                    </select>
                </div>
                <div class="card-custom overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse text-[11px]">
                            <thead class="bg-slate-50 dark:bg-slate-800 uppercase font-black text-slate-500 text-[9px]">
                                <tr>
                                    <th class="p-4">Informasi Dokumen</th>
                                    <th class="p-4 text-center">QR & Label</th>
                                    <th class="p-4 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="modalQR" class="fixed inset-0 bg-black/80 z-[4000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white p-8 rounded-[2rem] text-center max-w-xs w-full shadow-2xl">
        <h3 id="qrTitle" class="font-black text-[10px] uppercase mb-4 text-slate-400"></h3>
        <div id="qrcode" class="flex justify-center mb-6 p-4 bg-white border rounded-2xl"></div>
        <button onclick="closeQR()" class="w-full bg-slate-900 text-white py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Tutup Preview</button>
    </div>
</div>

<div id="modalBantuan" class="fixed inset-0 bg-black/70 z-[1002] hidden flex items-center justify-center p-4 backdrop-blur-md">
    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
        <div class="p-6 bg-blue-600 text-white flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-circle-info text-2xl"></i>
                <div>
                    <h2 class="font-black text-sm uppercase italic">Panduan</h2>
                    <p class="text-[9px] opacity-80 uppercase tracking-widest">E-Arsip Digital PKM Kiarapedes</p><strong>Perbup 135/2023</strong>
                </div>
            </div>
            <button onclick="toggleBantuan()" class="text-2xl font-bold hover:scale-110 transition-transform">&times;</button>
        </div>

        <div class="p-8 overflow-y-auto space-y-8">
            <div class="flex gap-4">
                <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-xl flex-shrink-0 flex items-center justify-center font-black">1</div>
                <div>
                    <h3 class="font-black text-xs uppercase text-slate-800 dark:text-white mb-2">Cara Registrasi Arsip</h3>
                    <p class="text-[11px] text-slate-500 leading-relaxed">Pilih <b>Klaster ILP</b> yang sesuai (misal: Klaster 2 untuk KIA). Masukkan nomor urut dari buku agenda. Pastikan Anda mengunggah file PDF atau menyertakan link Cloud agar dokumen bisa diakses oleh petugas lain.</p>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex-shrink-0 flex items-center justify-center font-black">2</div>
                <div>
                    <h3 class="font-black text-xs uppercase text-slate-800 dark:text-white mb-2">Memahami Tooltip Kode</h3>
                    <p class="text-[11px] text-slate-500 leading-relaxed">Arahkan kursor pada <b>Nomor Surat</b> di tabel. Sistem akan menampilkan detail klasifikasi sesuai <b>Perbup 135/2023</b>. Jika muncul "Detail tidak tersedia", pastikan kode angka di depan nomor surat sudah benar.</p>
                </div>
            </div>

            <div class="flex gap-4">
                <div class="w-10 h-10 bg-orange-100 text-orange-600 rounded-xl flex-shrink-0 flex items-center justify-center font-black">3</div>
                <div>
                    <h3 class="font-black text-xs uppercase text-slate-800 dark:text-white mb-2">Pencetakan Label & QR</h3>
                    <p class="text-[11px] text-slate-500 leading-relaxed">Gunakan tombol <i class="fas fa-print text-orange-500"></i> untuk mencetak label fisik. Tempelkan pada punggung map dokumen. QR Code memudahkan pencarian digital hanya dengan melakukan scan melalui kamera HP.</p>
                </div>
            </div>

            <div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl border-l-4 border-blue-500">
                <p class="text-[10px] font-bold text-slate-600 dark:text-slate-400 italic">
                    <i class="fas fa-shield-halved mr-2"></i><b>Tips Keamanan:</b> Lakukan "Sync (tombol berwarna merah)" secara berkala setelah menambah data agar database tersimpan aman di server pusat.
                </p>
            </div>
        </div>

        <div class="p-6 bg-slate-100 dark:bg-slate-800 text-center">
            <button onclick="toggleBantuan()" class="bg-blue-600 text-white px-10 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-blue-200">Saya Mengerti</button>
        </div>
    </div>
</div>

<script>
if (!localStorage.getItem('pkm_session_active')) {
    window.location.href = 'index.html'; 
}
const GAS_URL = "https://script.google.com/macros/s/AKfycby-9A5qG4YBAIBr9xxiJEpJqeJCToz6WTPiJEoc1BvaAqHxpPenO81i9hMRaKIfrW0H/exec";
const PIN_HASH = "MjAyNg==";
let isLoggedIn = false;
let fileData = null;
let editIndex = null;
let database = JSON.parse(localStorage.getItem('db_arsip_ilp_final')) || [];

const KLASTER = {
    "Klaster 1: Manajemen": ["440.11 (RUK)", "440.12 (RPK)", "440.2 (Org)", "005 (Minlok)", "800 (Kepegawaian)", "900 (Keuangan)"],
    "Klaster 2: Ibu & Anak": ["441.11 (ANC)", "441.12 (PNC)", "441.21 (Imunisasi)", "441.22 (Stunting)", "441.31 (UKS)"],
    "Klaster 3: Dewasa & Lansia": ["440.51 (PTM)", "440.52 (IVA)", "440.53 (Jiwa)", "441.61 (Lansia)"],
    "Klaster 4: P2P & Kesling": ["443.11 (TB)", "443.12 (HIV)", "443.21 (DBD)", "448.1 (STBM)"],
    "Lintas Klaster": ["442.1 (Obat)", "445.1 (Lab)", "440.61 (Promkes)"]
};

const KLASTER_DETAIL = {
    "440.11": "Rencana Usulan Kegiatan (RUK)", "440.12": "Rencana Pelaksanaan Kegiatan (RPK)", "440.2": "Organisasi/Tata Laksana", "005": "Minilokarya Puskesmas", "800": "Kepegawaian/SK/STR", "900": "Keuangan/BOK/JKN", "441.11": "Kesehatan Ibu Hamil (ANC)", "441.12": "Persalinan & Nifas (PNC)", "441.21": "Imunisasi Dasar", "441.22": "Stunting/SDIDTK", "441.31": "UKS/Sekolah", "440.51": "Skrining PTM (HT/DM)", "440.52": "Skrining Kanker IVA", "440.53": "Keswa & Napza", "441.61": "Posyandu Lansia", "443.11": "TBC & Kusta", "443.12": "HIV/AIDS", "443.21": "Demam Berdarah", "448.1": "STBM/Kesling", "442.1": "Farmasi/Obat", "445.1": "Laboratorium", "440.61": "Promkes"
};

// --- CORE FUNCTIONS ---
function verifikasiPin() {
    if (btoa(document.getElementById('pinInput').value) === PIN_HASH) {
        isLoggedIn = true;
        document.getElementById('modalLogin').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        initApp();
    } else { alert("PIN SALAH!"); }
}

function initApp() {
    const kSel = document.getElementById('selKlaster');
    const fSel = document.getElementById('filterKlaster');
    const opts = Object.keys(KLASTER).map(k => `<option value="${k}">${k}</option>`).join('');
    kSel.innerHTML = opts; fSel.innerHTML += opts;
    updateSub(); renderTable(); updateStats();
}

function toggleTheme() {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    document.getElementById('themeIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}

function updateSub() {
    const k = document.getElementById('selKlaster').value;
    document.getElementById('selSub').innerHTML = KLASTER[k].map(s => `<option value="${s}">${s}</option>`).join('');
    generatePreview();
}

function generatePreview() {
    const s = document.getElementById('selSub').value;
    const kode = s.split(' ')[0].trim();
    const no = (document.getElementById('noUrut').value || "0").padStart(3, '0');
    const thn = new Date(document.getElementById('arsipTgl').value || new Date()).getFullYear();
    const nomor = `${kode}/${no}/PKM-KPDS/${thn}`;
    document.getElementById('displayNomor').innerHTML = `${nomor}<br><span class="text-[9px] text-emerald-500 font-bold italic">ℹ️ ${KLASTER_DETAIL[kode] || ""}</span>`;
    return nomor;
}

// --- DATA HANDLING ---
document.getElementById('arsipFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => fileData = { base64: ev.target.result.split(',')[1], name: file.name, type: file.type };
    reader.readAsDataURL(file);
};

document.getElementById('formArsip').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btnSimpan');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> MENGUNGGAH...';

    const payload = {
        no: generatePreview(),
        nama: document.getElementById('arsipNama').value.toUpperCase(),
        klaster: document.getElementById('selKlaster').value,
        sub: document.getElementById('selSub').value,
        tgl: document.getElementById('arsipTgl').value || new Date().toISOString().split('T')[0],
        fileData: fileData ? fileData.base64 : null,
        fileName: fileData ? fileData.name : "",
        fileType: fileData ? fileData.type : "",
        token: "2026"
    };

    try {
        if (editIndex !== null) {
            database[editIndex] = { ...database[editIndex], ...payload, link: database[editIndex].link };
        } else {
            const localEntry = { ...payload, link: "#" }; delete localEntry.fileData;
            database.unshift(localEntry);
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        }
        localStorage.setItem('db_arsip_ilp_final', JSON.stringify(database));
        renderTable(); updateStats(); e.target.reset(); fileData = null; editIndex = null;
        alert("Data Berhasil Diarsipkan!");
    } catch (err) { alert("Error: " + err.message); }
    finally { btn.disabled = false; btn.innerText = "Simpan & Upload Ke Cloud"; }
};

function renderTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filter = document.getElementById('filterKlaster').value;
    const filtered = database.filter(x => (x.no.toLowerCase().includes(search) || x.nama.toLowerCase().includes(search)) && (filter === "Semua" || x.klaster === filter));

    document.getElementById('tableBody').innerHTML = filtered.map((x, i) => {
        const kodeMurni = x.no.split('/')[0].trim();
        return `
        <tr class="border-b dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-all">
            <td class="p-4">
                <div class="group relative inline-block">
                    <span class="font-mono text-emerald-600 font-black cursor-help border-b border-dotted border-emerald-300">${x.no}</span>
                    <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block z-50 w-56 p-2 bg-slate-800 text-white text-[9px] rounded-lg shadow-xl uppercase font-bold italic">
                        Klasifikasi: ${KLASTER_DETAIL[kodeMurni] || "Tidak Terdaftar"}
                    </div>
                </div>
                <div class="font-black text-slate-800 dark:text-slate-200 uppercase mt-1 text-[10px] leading-tight">${x.nama}</div>
                <div class="text-[9px] text-slate-400 font-bold mt-1 uppercase">${x.klaster} • ${x.tgl}</div>
            </td>
            <td class="p-4">
                <div class="flex justify-center gap-2">
                    <button onclick="showQR('${x.no}')" class="btn-action bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"><i class="fas fa-qrcode"></i></button>
                    <button onclick="printLabel(${i})" class="btn-action bg-emerald-50 text-emerald-600"><i class="fas fa-tag"></i></button>
                </div>
            </td>
            <td class="p-4">
                <div class="flex justify-center gap-2">
                    <a href="${x.link}" target="_blank" class="btn-action bg-blue-50 text-blue-600 ${x.link === '#' ? 'opacity-30 pointer-events-none' : ''}"><i class="fas fa-file-pdf"></i></a>
                    <button onclick="hapus(${i})" class="btn-action bg-rose-50 text-rose-600"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function updateStats() {
    const counts = {};
    let total = database.length;
    database.forEach(x => counts[x.klaster] = (counts[x.klaster] || 0) + 1);

    document.getElementById('totalArsip').innerText = `${total} Data`;
    document.getElementById('sebaranKlaster').innerHTML = Object.keys(KLASTER).map(k => {
        const c = counts[k] || 0;
        const p = total > 0 ? (c / total * 100).toFixed(0) : 0;
        return `
            <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                    <span class="text-slate-500">${k.split(':')[0]}</span>
                    <span class="text-emerald-600">${c}</span>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-emerald-500 h-full" style="width: ${p}%"></div>
                </div>
            </div>
        `;
    }).join('');
}

// --- UTILITIES ---
function showQR(t) {
    document.getElementById('modalQR').classList.remove('hidden');
    document.getElementById('qrTitle').innerText = t;
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById("qrcode"), { text: t, width: 160, height: 160 });
}
function closeQR() { document.getElementById('modalQR').classList.add('hidden'); }
function toggleBantuan() { document.getElementById('modalBantuan').classList.toggle('hidden'); }

function printLabel(i) {
    const x = database[i];
    const win = window.open('', '_blank');
    win.document.write(`
        <div style="width:300px; padding:20px; border:2px solid #000; font-family:sans-serif; position:relative;">
            <div style="font-size:10px; font-weight:bold; border-bottom:2px solid #000; padding-bottom:5px; margin-bottom:10px;">LABEL ARSIP PKM KIARAPEDES</div>
            <div style="font-size:16px; font-weight:900; letter-spacing:-0.5px;">${x.no}</div>
            <div style="font-size:10px; margin:8px 0; font-weight:bold;">${x.nama}</div>
            <div style="font-size:9px; color:#666;">UNIT: ${x.klaster} | TGL: ${x.tgl}</div>
            <div id="q" style="margin-top:15px; display:flex; justify-content:center;"></div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
        <script>new QRCode(document.getElementById("q"), {text:"${x.no}", width:70, height:70}); setTimeout(()=>window.print(), 800);<\/script>
    `);
}

function exportToExcel() {
    const ws = XLSX.utils.json_to_sheet(database);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Database_Arsip");
    XLSX.writeFile(wb, `Arsip_PKM_Kiarapedes_${new Date().toLocaleDateString()}.xlsx`);
}

async function syncFromGAS() {
    const icon = document.getElementById('syncIcon');
    icon.classList.add('fa-spin');
    try {
        const res = await fetch(GAS_URL);
        database = await res.json();
        localStorage.setItem('db_arsip_ilp_final', JSON.stringify(database));
        renderTable(); updateStats();
        alert("Sinkronisasi Berhasil!");
    } catch(e) { alert("Gagal Sync!"); }
    finally { icon.classList.remove('fa-spin'); }
}

function hapus(i) {
    if(confirm("Hapus data ini secara permanen dari perangkat?")) {
        database.splice(i, 1);
        localStorage.setItem('db_arsip_ilp_final', JSON.stringify(database));
        renderTable(); updateStats();
    }
}

function toggleBantuan() {
    const m = document.getElementById('modalBantuan');
    m.classList.toggle('hidden');
}

</script>
</body>
</html>
